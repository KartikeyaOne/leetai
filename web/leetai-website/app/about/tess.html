
<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HealthTrack Pro | Enterprise Health Analytics Dashboard</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Font Awesome - Using kit for easier icon updates -->
    <!-- <script src="https://kit.fontawesome.com/YOUR_KIT_CODE.js" crossorigin="anonymous"></script>  -->
    <!-- Make sure to replace YOUR_KIT_CODE with your actual Font Awesome kit code -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        /* ===== CSS VARIABLES & THEME SYSTEM ===== */
        :root {
            /* Base Colors - Light Theme */
            --primary-hue: 210;
            --primary-saturation: 100%;
            --primary-lightness: 50%;
            --primary-color: hsl(var(--primary-hue), var(--primary-saturation), var(--primary-lightness));
            --primary-light: hsl(var(--primary-hue), 85%, 95%);
            --primary-lighter: hsl(var(--primary-hue), 90%, 97%);
            --primary-dark: hsl(var(--primary-hue), 100%, 40%);
            --primary-darker: hsl(var(--primary-hue), 100%, 30%);

            --success-hue: 145;
            --success-saturation: 65%;
            --success-lightness: 40%;
            --success-color: hsl(var(--success-hue), var(--success-saturation), var(--success-lightness));
            --success-light: hsl(var(--success-hue), 55%, 92%);
            --success-lighter: hsl(var(--success-hue), 60%, 97%);
            --success-dark: hsl(var(--success-hue), 70%, 30%);

            --warning-hue: 40;
            --warning-saturation: 90%;
            --warning-lightness: 50%;
            --warning-color: hsl(var(--warning-hue), var(--warning-saturation), var(--warning-lightness));
            --warning-light: hsl(var(--warning-hue), 80%, 92%);
            --warning-lighter: hsl(var(--warning-hue), 85%, 97%);
            --warning-dark: hsl(var(--warning-hue), 95%, 40%);

            --danger-hue: 0;
            --danger-saturation: 70%;
            --danger-lightness: 50%;
            --danger-color: hsl(var(--danger-hue), var(--danger-saturation), var(--danger-lightness));
            --danger-light: hsl(var(--danger-hue), 60%, 92%);
            --danger-lighter: hsl(var(--danger-hue), 65%, 97%);
            --danger-dark: hsl(var(--danger-hue), 75%, 40%);

            --neutral-hue: 220;
            --neutral-saturation: 15%;
            --neutral-50: hsl(var(--neutral-hue), var(--neutral-saturation), 98%);
            --neutral-100: hsl(var(--neutral-hue), var(--neutral-saturation), 96%);
            --neutral-200: hsl(var(--neutral-hue), var(--neutral-saturation), 92%);
            --neutral-300: hsl(var(--neutral-hue), var(--neutral-saturation), 88%);
            --neutral-400: hsl(var(--neutral-hue), var(--neutral-saturation), 70%);
            --neutral-500: hsl(var(--neutral-hue), var(--neutral-saturation), 60%);
            --neutral-600: hsl(var(--neutral-hue), var(--neutral-saturation), 45%);
            --neutral-700: hsl(var(--neutral-hue), var(--neutral-saturation), 35%);
            --neutral-800: hsl(var(--neutral-hue), var(--neutral-saturation), 25%);
            --neutral-900: hsl(var(--neutral-hue), var(--neutral-saturation), 15%);
            --neutral-950: hsl(var(--neutral-hue), var(--neutral-saturation), 10%);

            /* UI Elements - Light Theme */
            --background-color: var(--neutral-50);
            --card-background: #FFFFFF;
            --sidebar-background: #FFFFFF;
            --header-background: #FFFFFF;
            --text-color: var(--neutral-900);
            --text-muted: var(--neutral-600);
            --text-light: var(--neutral-500);
            --border-color: var(--neutral-200);
            --divider-color: var(--neutral-100);
            --input-bg: #FFFFFF;
            --input-border: var(--neutral-300);
            --input-focus-border: var(--primary-color);
            --input-focus-shadow: hsla(var(--primary-hue), var(--primary-saturation), var(--primary-lightness), 0.2);
            --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.05);
            --shadow: 0 1px 3px rgba(0, 0, 0, 0.1), 0 1px 2px rgba(0, 0, 0, 0.06);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            --shadow-inner: inset 0 2px 4px 0 rgba(0, 0, 0, 0.06);
            --shadow-outline: 0 0 0 3px var(--input-focus-shadow);

            /* Typography */
            --font-sans: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            --font-mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
            --font-weight-light: 300;
            --font-weight-normal: 400;
            --font-weight-medium: 500;
            --font-weight-semibold: 600;
            --font-weight-bold: 700;

            /* Spacing & Layout */
            --header-height: 70px;
            --sidebar-width: 280px;
            --sidebar-collapsed-width: 80px;
            --border-radius-sm: 0.375rem;
            --border-radius: 0.5rem;
            --border-radius-md: 0.75rem;
            --border-radius-lg: 1rem;
            --border-radius-xl: 1.5rem;
            --border-radius-full: 9999px;

            /* Animation */
            --transition-fast: 150ms;
            --transition-normal: 250ms;
            --transition-slow: 350ms;
            --transition-timing: cubic-bezier(0.4, 0, 0.2, 1);
            --transition-bounce: cubic-bezier(0.34, 1.56, 0.64, 1);

            /* Z-index layers */
            --z-negative: -1;
            --z-elevate: 1;
            --z-sticky: 100;
            --z-drawer: 200;
            --z-dropdown: 300;
            --z-modal: 400;
            --z-popover: 500;
            --z-tooltip: 600;
            --z-toast: 700;
            --z-overlay: 800;
        }

        /* Dark Theme */
        html[data-theme="dark"] {
            --primary-lightness: 55%;
            --primary-light: hsla(var(--primary-hue), 70%, 20%, 0.5);
            --primary-lighter: hsla(var(--primary-hue), 70%, 15%, 0.5);

            --success-lightness: 45%;
            --success-light: hsla(var(--success-hue), 50%, 20%, 0.5);
            --success-lighter: hsla(var(--success-hue), 50%, 15%, 0.5);

            --warning-lightness: 55%;
            --warning-light: hsla(var(--warning-hue), 70%, 20%, 0.5);
            --warning-lighter: hsla(var(--warning-hue), 70%, 15%, 0.5);

            --danger-lightness: 55%;
            --danger-light: hsla(var(--danger-hue), 60%, 20%, 0.5);
            --danger-lighter: hsla(var(--danger-hue), 60%, 15%, 0.5);

            --background-color: hsl(var(--neutral-hue), 15%, 8%);
            --card-background: hsl(var(--neutral-hue), 15%, 12%);
            --sidebar-background: hsl(var(--neutral-hue), 15%, 10%);
            --header-background: hsl(var(--neutral-hue), 15%, 10%);
            --text-color: hsl(var(--neutral-hue), 10%, 90%);
            --text-muted: hsl(var(--neutral-hue), 10%, 70%);
            --text-light: hsl(var(--neutral-hue), 10%, 60%);
            --border-color: hsl(var(--neutral-hue), 15%, 20%);
            --divider-color: hsl(var(--neutral-hue), 15%, 15%);
            --input-bg: hsl(var(--neutral-hue), 15%, 15%);
            --input-border: hsl(var(--neutral-hue), 15%, 25%);

            --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.3);
            --shadow: 0 1px 3px rgba(0, 0, 0, 0.4), 0 1px 2px rgba(0, 0, 0, 0.3);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.4), 0 2px 4px -1px rgba(0, 0, 0, 0.3);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.4), 0 4px 6px -2px rgba(0, 0, 0, 0.3);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.4), 0 10px 10px -5px rgba(0, 0, 0, 0.3);
            --shadow-inner: inset 0 2px 4px 0 rgba(0, 0, 0, 0.3);
        }

        /* ===== BASE STYLES ===== */
        *, *::before, *::after {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            transition: background-color var(--transition-normal) var(--transition-timing),
                        color var(--transition-normal) var(--transition-timing),
                        border-color var(--transition-normal) var(--transition-timing),
                        box-shadow var(--transition-normal) var(--transition-timing);
        }

        html {
            scroll-behavior: smooth;
            font-size: 16px;
        }

        body {
            font-family: var(--font-sans);
            background-color: var(--background-color);
            color: var(--text-color);
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            overflow-x: hidden;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: var(--background-color);
            border-radius: var(--border-radius-full);
        }
        ::-webkit-scrollbar-thumb {
            background-color: var(--neutral-400);
            border-radius: var(--border-radius-full);
            border: 2px solid transparent;
            background-clip: content-box;
        }
        ::-webkit-scrollbar-thumb:hover {
            background-color: var(--neutral-500);
        }

        /* Typography */
        h1, h2, h3, h4, h5, h6 {
            color: var(--text-color);
            line-height: 1.2;
            font-weight: var(--font-weight-semibold);
            margin-bottom: 1rem; /* Added default margin */
        }

        h1 {
            font-size: 1.75rem;
        }

        h2 {
            font-size: 1.5rem;
        }

        h3 {
            font-size: 1.25rem;
        }

        h4 {
            font-size: 1.125rem;
        }

        p {
            margin-bottom: 1rem;
        }

        a {
            color: var(--primary-color);
            text-decoration: none;
            transition: color var(--transition-fast) var(--transition-timing);
        }

        a:hover {
            color: var(--primary-dark);
            text-decoration: underline;
        }

        /* ===== LAYOUT ===== */
        .app-container {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        .content-wrapper {
            display: flex;
            flex: 1;
            position: relative; /* Needed for sidebar positioning on mobile */
        }

        /* Header */
        .header {
            height: var(--header-height);
            background-color: var(--header-background);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 1.5rem;
            position: sticky;
            top: 0;
            z-index: var(--z-sticky);
            box-shadow: var(--shadow-sm);
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-weight: var(--font-weight-bold);
            font-size: 1.25rem;
            color: var(--text-color);
            text-decoration: none; /* Ensure logo is not underlined */
        }
        .logo:hover {
             text-decoration: none; /* Ensure logo is not underlined on hover */
        }


        .logo-icon {
            color: var(--primary-color);
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .logo-text {
            display: flex;
            flex-direction: column;
        }

        .logo-name {
            font-weight: var(--font-weight-bold);
            line-height: 1.2;
        }

        .logo-tagline {
            font-size: 0.7rem;
            color: var(--text-muted);
            font-weight: var(--font-weight-normal);
            letter-spacing: 0.05em;
            text-transform: uppercase;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        /* Sidebar */
        .sidebar {
            width: var(--sidebar-width);
            background-color: var(--sidebar-background);
            border-right: 1px solid var(--border-color);
            height: calc(100vh - var(--header-height));
            position: sticky; /* Changed from sticky */
            top: var(--header-height);
            overflow-y: auto;
            transition: width var(--transition-normal) var(--transition-timing),
                        transform var(--transition-normal) var(--transition-timing);
            z-index: var(--z-drawer);
            display: flex;
            flex-direction: column;
            flex-shrink: 0; /* Prevent sidebar from shrinking */
        }

        .sidebar.collapsed {
            width: var(--sidebar-collapsed-width);
            overflow-x: hidden; /* Hide text when collapsed */
        }

        .sidebar-toggle {
            position: absolute;
            right: -12px;
            top: 20px;
            width: 24px;
            height: 24px;
            background-color: var(--primary-color);
            color: white;
            border-radius: var(--border-radius-full);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: var(--z-elevate);
            box-shadow: var(--shadow);
            border: 2px solid var(--card-background);
            transition: transform var(--transition-normal) var(--transition-bounce),
                        background-color var(--transition-normal) var(--transition-timing);
        }

        .sidebar-toggle:hover {
            background-color: var(--primary-dark);
            transform: scale(1.1);
        }

        .sidebar.collapsed .sidebar-toggle i {
            transform: rotate(180deg);
        }

        .nav-section {
            padding: 1.5rem 1rem;
            border-bottom: 1px solid var(--divider-color);
            flex-shrink: 0; /* Prevent shrinking */
        }
        .nav-section:first-of-type {
             padding-top: 2rem; /* More space at the top */
        }
        .nav-section:last-of-type {
            border-bottom: none;
            flex-grow: 1; /* Allow last section to grow */
        }

        .nav-section-title {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-light);
            margin-bottom: 1rem;
            padding-left: 0.5rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            transition: opacity var(--transition-normal) var(--transition-timing);
        }

        .sidebar.collapsed .nav-section-title {
            opacity: 0;
            height: 0;
            margin: 0;
            padding: 0;
            overflow: hidden;
        }

        .nav-list {
            list-style: none;
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .nav-item {
            border-radius: var(--border-radius);
            transition: background-color var(--transition-fast) var(--transition-timing);
        }

        .nav-link {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem;
            color: var(--text-color);
            border-radius: var(--border-radius);
            text-decoration: none;
            transition: background-color var(--transition-fast) var(--transition-timing), color var(--transition-fast) var(--transition-timing);
            position: relative;
            overflow: hidden;
            white-space: nowrap; /* Prevent text wrapping */
        }

        .nav-link:hover {
            background-color: var(--neutral-100);
            text-decoration: none;
            color: var(--text-color);
        }

        html[data-theme="dark"] .nav-link:hover {
            background-color: var(--neutral-800);
        }

        .nav-link.active {
            background-color: var(--primary-lighter);
            color: var(--primary-color);
            font-weight: var(--font-weight-medium);
        }

        html[data-theme="dark"] .nav-link.active {
            background-color: var(--primary-light);
        }

        .nav-link.active::before {
            content: '';
            position: absolute;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
            height: 70%;
            width: 4px;
            background-color: var(--primary-color);
            border-radius: 0 var(--border-radius-sm) var(--border-radius-sm) 0;
        }

        .nav-icon {
            width: 1.25rem;
            height: 1.25rem;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .nav-text {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            transition: opacity var(--transition-normal) var(--transition-timing);
        }

        .sidebar.collapsed .nav-text {
            opacity: 0;
            width: 0;
        }

        .sidebar-footer {
            margin-top: auto;
            padding: 1rem;
            border-top: 1px solid var(--divider-color);
            display: flex;
            align-items: center;
            gap: 0.75rem;
            flex-shrink: 0; /* Prevent shrinking */
        }

        .sidebar.collapsed .sidebar-footer {
            flex-direction: column;
            padding: 1rem 0;
            align-items: center; /* Center items when collapsed */
            justify-content: center;
        }

        .sidebar-footer-text {
            font-size: 0.75rem;
            color: var(--text-muted);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            transition: opacity var(--transition-normal) var(--transition-timing), width var(--transition-normal) var(--transition-timing), height var(--transition-normal) var(--transition-timing);
        }

        .sidebar.collapsed .sidebar-footer-text {
            opacity: 0;
            width: 0;
            height: 0;
            overflow: hidden;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            padding: 2rem;
            max-width: 100%;
            overflow-x: hidden;
            min-width: 0; /* Prevent content from pushing sidebar */
        }

        .section {
            display: none; /* Hidden by default */
            animation: fadeIn 0.5s var(--transition-timing) forwards;
        }
        .section.active {
            display: block; /* Show active section */
        }


        /* Dashboard Grid */
        .dashboard-grid {
            display: grid;
            /* Adjusted minmax for slightly larger cards */
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        /* Explicit column spans for larger layouts */
        @media (min-width: 768px) {
            .dashboard-grid-2col {
                grid-column: span 2;
            }
            .dashboard-grid-3col {
                grid-column: span 3;
            }
             /* Ensure 3-col spans full width on medium screens */
            .dashboard-grid-3col {
                grid-template-columns: repeat(3, 1fr); /* Example for a 3-col layout */
            }
        }
        @media (min-width: 1200px) {
             /* Ensure 3-col fits nicely */
            .dashboard-grid {
                grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            }
        }


        /* Cards */
        .card {
            background-color: var(--card-background);
            border-radius: var(--border-radius-md);
            box-shadow: var(--shadow);
            overflow: hidden;
            transition: transform var(--transition-normal) var(--transition-timing),
                        box-shadow var(--transition-normal) var(--transition-timing);
            position: relative;
            border: 1px solid var(--border-color);
             display: flex; /* Use flexbox for better internal layout */
            flex-direction: column; /* Stack header, body, footer */
        }

        .card:hover {
            box-shadow: var(--shadow-md);
            transform: translateY(-2px);
        }

        .card-header {
            padding: 1.25rem 1.5rem;
            border-bottom: 1px solid var(--divider-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-shrink: 0; /* Prevent header shrinking */
        }

        .card-title {
            font-size: 1.125rem;
            font-weight: var(--font-weight-semibold);
            color: var(--text-color);
            display: flex;
            align-items: center;
            gap: 0.75rem;
            margin-bottom: 0; /* Override default heading margin */
        }

        .card-title-icon {
            color: var(--primary-color);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .card-actions {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .card-body {
            padding: 1.5rem;
            flex-grow: 1; /* Allow body to take available space */
        }

        .card-footer {
            padding: 1rem 1.5rem;
            border-top: 1px solid var(--divider-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
            background-color: var(--neutral-50); /* Slightly different background */
            flex-shrink: 0; /* Prevent footer shrinking */
        }
        html[data-theme="dark"] .card-footer {
            background-color: hsl(var(--neutral-hue), 15%, 15%);
        }


        /* Stats Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); /* Smaller min size */
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background-color: var(--card-background);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
            transition: transform var(--transition-normal) var(--transition-timing),
                        box-shadow var(--transition-normal) var(--transition-timing);
            border: 1px solid var(--border-color);
            position: relative;
            overflow: hidden;
        }

        .stat-card:hover {
            box-shadow: var(--shadow-md);
            transform: translateY(-2px);
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background-color: var(--primary-color); /* Default to primary */
            transition: background-color var(--transition-normal) var(--transition-timing);
        }

        /* Add class for primary explicitly if needed */
        .stat-card.primary::before {
             background-color: var(--primary-color);
        }
        .stat-card.primary .stat-icon {
            background-color: var(--primary-lighter);
            color: var(--primary-color);
        }
        html[data-theme="dark"] .stat-card.primary .stat-icon {
             background-color: var(--primary-light);
             color: var(--primary-color);
        }


        .stat-card.success::before {
            background-color: var(--success-color);
        }

        .stat-card.warning::before {
            background-color: var(--warning-color);
        }

        .stat-card.danger::before {
            background-color: var(--danger-color);
        }

        .stat-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .stat-title {
            font-size: 0.875rem;
            color: var(--text-muted);
            font-weight: var(--font-weight-medium);
        }

        .stat-icon {
            width: 2.5rem;
            height: 2.5rem;
            border-radius: var(--border-radius);
            /* Default style removed, applied via specific classes */
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color var(--transition-normal) var(--transition-timing),
                        color var(--transition-normal) var(--transition-timing);
        }

        .stat-card.success .stat-icon {
            background-color: var(--success-lighter);
            color: var(--success-color);
        }
         html[data-theme="dark"] .stat-card.success .stat-icon {
             background-color: var(--success-light);
             color: var(--success-color);
        }

        .stat-card.warning .stat-icon {
            background-color: var(--warning-lighter);
            color: var(--warning-color);
        }
         html[data-theme="dark"] .stat-card.warning .stat-icon {
             background-color: var(--warning-light);
             color: var(--warning-color);
        }

        .stat-card.danger .stat-icon {
            background-color: var(--danger-lighter);
            color: var(--danger-color);
        }
         html[data-theme="dark"] .stat-card.danger .stat-icon {
             background-color: var(--danger-light);
             color: var(--danger-color);
        }


        .stat-value {
            font-size: 1.75rem;
            font-weight: var(--font-weight-bold);
            color: var(--text-color);
            line-height: 1.2; /* Ensure consistent line height */
        }

        .stat-comparison {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
            color: var(--text-muted);
            flex-wrap: wrap; /* Allow wrapping on small cards */
        }

        .stat-change {
            display: flex;
            align-items: center;
            gap: 0.25rem;
            font-weight: var(--font-weight-medium);
            margin-left: auto; /* Push change indicator to the right */
        }

        .stat-change.positive {
            color: var(--success-color);
        }

        .stat-change.negative {
            color: var(--danger-color);
        }
        .stat-change.neutral { /* Added neutral style */
            color: var(--text-muted);
        }

        /* Forms */
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            position: relative;
        }

        .form-label {
            font-size: 0.875rem;
            font-weight: var(--font-weight-medium);
            color: var(--text-muted);
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
            transition: color var(--transition-fast) var(--transition-timing);
        }

        .form-label-icon {
            color: var(--text-muted);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: color var(--transition-fast) var(--transition-timing);
        }

        .form-control {
            padding: 0.75rem 1rem;
            font-size: 1rem;
            font-family: var(--font-sans);
            border: 1px solid var(--input-border);
            border-radius: var(--border-radius);
            background-color: var(--input-bg);
            color: var(--text-color);
            transition: border-color var(--transition-fast) var(--transition-timing),
                        box-shadow var(--transition-fast) var(--transition-timing);
            width: 100%;
             appearance: none; /* Better consistency across browsers */
            -webkit-appearance: none;
            -moz-appearance: none;
        }

         /* Style for select dropdown arrow */
        select.form-control {
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='%23343a40' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M2 5l6 6 6-6'/%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 0.75rem center;
            background-size: 16px 12px;
            padding-right: 2.5rem; /* Make space for arrow */
        }
        html[data-theme="dark"] select.form-control {
             background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='%23adb5bd' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M2 5l6 6 6-6'/%3e%3c/svg%3e");
        }

        .form-control::placeholder {
            color: var(--text-light);
            opacity: 0.7;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--input-focus-border);
            box-shadow: 0 0 0 3px var(--input-focus-shadow);
        }

        .form-group:focus-within .form-label,
        .form-group:focus-within .form-label-icon {
            color: var(--primary-color);
        }

        .form-error {
            font-size: 0.75rem;
            color: var(--danger-color);
            margin-top: 0.25rem;
            display: none; /* Hidden by default */
        }

        .form-group.error .form-control {
            border-color: var(--danger-color);
        }
        /* Show error message when .error class is added */
        .form-group.error .form-error {
            display: block;
        }

        .form-hint {
            font-size: 0.75rem;
            color: var(--text-light);
            margin-top: 0.25rem;
        }

        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 0.75rem 1.5rem;
            font-size: 0.875rem;
            font-weight: var(--font-weight-medium);
            color: white;
            background-color: var(--primary-color);
            border: 1px solid transparent;
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: background-color var(--transition-fast) var(--transition-timing),
                        transform var(--transition-fast) var(--transition-timing),
                        box-shadow var(--transition-fast) var(--transition-timing),
                        border-color var(--transition-fast) var(--transition-timing), /* Added border transition */
                        color var(--transition-fast) var(--transition-timing); /* Added color transition */
            user-select: none;
            text-decoration: none;
            white-space: nowrap;
            box-shadow: var(--shadow-sm);
        }

        .btn:hover {
            background-color: var(--primary-dark);
            transform: translateY(-1px);
            box-shadow: var(--shadow);
            text-decoration: none;
            color: white;
        }

        .btn:active {
            transform: translateY(0);
            box-shadow: var(--shadow-sm);
        }

        .btn:focus-visible {
            outline: none;
            box-shadow: 0 0 0 3px var(--input-focus-shadow);
        }
         /* Disabled state */
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            box-shadow: none;
            transform: none;
        }


        .btn-sm {
            padding: 0.5rem 1rem;
            font-size: 0.75rem;
        }

        .btn-lg {
            padding: 0.875rem 1.75rem;
            font-size: 1rem;
        }

        .btn-icon {
            padding: 0.5rem;
            width: 2.5rem;
            height: 2.5rem;
            border-radius: var(--border-radius);
            flex-shrink: 0; /* Prevent icon buttons from shrinking */
        }

        .btn-icon-sm {
            padding: 0.375rem;
            width: 2rem;
            height: 2rem;
        }

        .btn-icon-lg {
            padding: 0.625rem;
            width: 3rem;
            height: 3rem;
        }

        .btn-success {
            background-color: var(--success-color);
        }

        .btn-success:hover {
            background-color: var(--success-dark);
        }

        .btn-warning {
            background-color: var(--warning-color);
            color: var(--neutral-900); /* Better contrast for warning */
        }
        .btn-warning:hover {
            background-color: var(--warning-dark);
            color: var(--neutral-900);
        }


        .btn-danger {
            background-color: var(--danger-color);
        }

        .btn-danger:hover {
            background-color: var(--danger-dark);
        }

        .btn-outline {
            background-color: transparent;
            border-color: var(--primary-color);
            color: var(--primary-color);
            box-shadow: none;
        }

        .btn-outline:hover {
            background-color: var(--primary-color);
            color: white;
            box-shadow: var(--shadow-sm);
        }

        .btn-outline-success {
            border-color: var(--success-color);
            color: var(--success-color);
            background-color: transparent;
            box-shadow: none;
        }

        .btn-outline-success:hover {
            background-color: var(--success-color);
            color: white;
            box-shadow: var(--shadow-sm);
        }

        .btn-outline-warning {
            border-color: var(--warning-color);
            color: var(--warning-color);
             background-color: transparent;
            box-shadow: none;
        }

        .btn-outline-warning:hover {
            background-color: var(--warning-color);
            color: var(--neutral-900); /* Consistent with solid warning */
            box-shadow: var(--shadow-sm);
        }

        .btn-outline-danger {
            border-color: var(--danger-color);
            color: var(--danger-color);
             background-color: transparent;
            box-shadow: none;
        }

        .btn-outline-danger:hover {
            background-color: var(--danger-color);
            color: white;
            box-shadow: var(--shadow-sm);
        }

        .btn-ghost {
            background-color: transparent;
            border-color: transparent;
            color: var(--text-color);
            box-shadow: none;
        }

        .btn-ghost:hover {
            background-color: var(--neutral-100);
            color: var(--text-color);
            box-shadow: none;
        }

        html[data-theme="dark"] .btn-ghost:hover {
            background-color: var(--neutral-800);
        }
         /* Active state for ghost/outline */
        .btn-ghost.active, .btn-outline.active {
            background-color: var(--primary-lighter);
            color: var(--primary-color);
        }
        html[data-theme="dark"] .btn-ghost.active,
        html[data-theme="dark"] .btn-outline.active {
            background-color: var(--primary-light);
        }

        .btn-group {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap; /* Allow wrapping */
        }

        /* Badges */
        .badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.25rem;
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
            font-weight: var(--font-weight-medium);
            color: white;
            background-color: var(--primary-color);
            border-radius: var(--border-radius-full);
            white-space: nowrap;
        }

        .badge-success {
            background-color: var(--success-color);
        }

        .badge-warning {
            background-color: var(--warning-color);
            color: var(--neutral-900); /* Contrast */
        }

        .badge-danger {
            background-color: var(--danger-color);
        }

        .badge-outline {
            background-color: transparent;
            border: 1px solid var(--primary-color);
            color: var(--primary-color);
        }

        .badge-outline-success {
             background-color: transparent;
            border: 1px solid var(--success-color);
            color: var(--success-color);
        }

        .badge-outline-warning {
             background-color: transparent;
            border: 1px solid var(--warning-color);
            color: var(--warning-color);
        }

        .badge-outline-danger {
             background-color: transparent;
            border: 1px solid var(--danger-color);
            color: var(--danger-color);
        }

        /* Alerts */
        .alert {
            padding: 1rem 1.25rem;
            border-radius: var(--border-radius);
            margin-bottom: 1.5rem;
            border-left: 4px solid var(--primary-color);
            background-color: var(--primary-lighter);
            color: var(--primary-dark);
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
        }
         html[data-theme="dark"] .alert {
             background-color: var(--primary-light);
             color: hsl(var(--primary-hue), 70%, 80%); /* Lighter text for dark mode */
         }

        .alert-icon {
            margin-top: 0.125rem;
            flex-shrink: 0;
            font-size: 1.25rem; /* Ensure icon size */
            line-height: 1; /* Prevent extra space */
        }

        .alert-content {
            flex: 1;
        }

        .alert-title {
            font-weight: var(--font-weight-semibold);
            margin-bottom: 0.25rem;
            color: inherit; /* Inherit color from parent alert */
        }

        .alert-message {
            margin-bottom: 0;
            font-size: 0.875rem;
            color: inherit; /* Inherit color */
        }
        .alert-message p:last-child { /* Remove margin from last paragraph */
            margin-bottom: 0;
        }

        .alert-success {
            border-color: var(--success-color);
            background-color: var(--success-lighter);
            color: var(--success-dark);
        }
         html[data-theme="dark"] .alert-success {
             background-color: var(--success-light);
             color: hsl(var(--success-hue), 50%, 75%);
         }

        .alert-warning {
            border-color: var(--warning-color);
            background-color: var(--warning-lighter);
            color: var(--warning-dark);
        }
         html[data-theme="dark"] .alert-warning {
             background-color: var(--warning-light);
             color: hsl(var(--warning-hue), 70%, 75%);
         }

        .alert-danger {
            border-color: var(--danger-color);
            background-color: var(--danger-lighter);
            color: var(--danger-dark);
        }
         html[data-theme="dark"] .alert-danger {
             background-color: var(--danger-light);
             color: hsl(var(--danger-hue), 60%, 75%);
         }
         /* Added Info/Primary style */
        .alert-primary {
             border-color: var(--primary-color);
             background-color: var(--primary-lighter);
             color: var(--primary-dark);
        }
        html[data-theme="dark"] .alert-primary {
            background-color: var(--primary-light);
            color: hsl(var(--primary-hue), 70%, 80%);
        }


        /* Progress */
        .progress {
            height: 0.5rem;
            background-color: var(--neutral-200);
            border-radius: var(--border-radius-full);
            overflow: hidden;
            margin: 0.5rem 0;
        }
         html[data-theme="dark"] .progress {
             background-color: var(--neutral-700);
         }


        .progress-bar {
            height: 100%;
            background-color: var(--primary-color);
            border-radius: var(--border-radius-full);
            transition: width var(--transition-slow) var(--transition-timing); /* Slower transition */
        }

        .progress-bar-success {
            background-color: var(--success-color);
        }

        .progress-bar-warning {
            background-color: var(--warning-color);
        }

        .progress-bar-danger {
            background-color: var(--danger-color);
        }

        .progress-label {
            display: flex;
            justify-content: space-between;
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-bottom: 0.25rem; /* Space before bar */
        }

        /* Charts */
        .chart-container {
            position: relative;
            width: 100%;
            height: 300px; /* Default height */
            min-height: 250px; /* Ensure minimum size */
        }
        .chart-container canvas {
             max-width: 100%; /* Ensure canvas respects container */
             max-height: 100%;
        }

        .chart-legend {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            margin-top: 1rem;
            justify-content: center; /* Center legend items */
        }

        .chart-legend-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
            color: var(--text-muted);
            cursor: pointer; /* Indicate clickable */
        }

        .chart-legend-color {
            width: 12px;
            height: 12px;
            border-radius: var(--border-radius-sm);
            flex-shrink: 0;
        }

        /* Tables */
        .table-container {
            overflow-x: auto;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            margin-bottom: 1.5rem;
            background-color: var(--card-background); /* Ensure bg for scroll */
        }

        .table {
            width: 100%;
            border-collapse: collapse;
            text-align: left;
            font-size: 0.875rem;
            min-width: 600px; /* Ensure table has min width for scroll */
        }

        .table th,
        .table td {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid var(--border-color);
            white-space: nowrap; /* Prevent text wrapping */
        }

        .table th {
            font-weight: var(--font-weight-semibold);
            color: var(--text-muted);
            background-color: var(--neutral-50); /* Header background */
            position: sticky;
            top: 0;
            z-index: var(--z-elevate);
        }
        html[data-theme="dark"] .table th {
             background-color: hsl(var(--neutral-hue), 15%, 15%);
        }

        .table tbody tr:last-child td {
            border-bottom: none;
        }

        .table tbody tr {
            transition: background-color var(--transition-fast) var(--transition-timing);
        }
        .table tbody tr:hover {
            background-color: var(--neutral-100);
        }

        html[data-theme="dark"] .table tbody tr:hover {
            background-color: var(--neutral-800);
        }

        .table-empty {
            text-align: center;
            padding: 2rem;
            color: var(--text-muted);
        }
         .table-empty i {
            font-size: 2rem;
            margin-bottom: 0.5rem;
            display: block;
         }
         /* Hide empty message if tbody has content */
        .table-container:has(tbody tr) .table-empty {
             display: none;
        }
         /* Show empty message if tbody is empty or only has placeholder */
        .table-container:has(tbody:empty) .table-empty,
        .table-container:has(tbody tr.placeholder) .table-empty {
            display: block;
        }


        /* Tooltips */
        [data-tooltip] {
            position: relative;
            cursor: help; /* Indicate help available */
        }
        [data-tooltip]::after {
            content: attr(data-tooltip); /* Get content from attribute */
            position: absolute;
            bottom: 110%; /* Position above element */
            left: 50%;
            transform: translateX(-50%) scale(0.8); /* Start small */
            padding: 0.5rem 0.75rem;
            background-color: var(--neutral-900);
            color: white;
            font-size: 0.75rem;
            font-weight: var(--font-weight-normal);
            line-height: 1.4;
            border-radius: var(--border-radius-sm);
            white-space: nowrap;
            z-index: var(--z-tooltip);
            opacity: 0;
            visibility: hidden;
            transition: opacity var(--transition-fast) var(--transition-timing),
                        transform var(--transition-fast) var(--transition-timing),
                        visibility 0s linear var(--transition-fast);
            box-shadow: var(--shadow-md);
            pointer-events: none;
        }
        /* Arrow */
        [data-tooltip]::before {
            content: '';
            position: absolute;
            bottom: calc(110% - 5px); /* Position below tooltip */
            left: 50%;
            transform: translateX(-50%) scale(0.8);
            border-width: 5px;
            border-style: solid;
            border-color: var(--neutral-900) transparent transparent transparent;
            opacity: 0;
            visibility: hidden;
            transition: opacity var(--transition-fast) var(--transition-timing),
                        transform var(--transition-fast) var(--transition-timing),
                        visibility 0s linear var(--transition-fast);
            z-index: var(--z-tooltip);
            pointer-events: none;
        }
        /* Show on hover/focus */
        [data-tooltip]:hover::after,
        [data-tooltip]:hover::before,
        [data-tooltip]:focus-visible::after,
        [data-tooltip]:focus-visible::before {
            opacity: 1;
            visibility: visible;
            transform: translateX(-50%) scale(1);
            transition-delay: 0s; /* Show immediately */
        }


        /* Modals */
        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: var(--z-modal);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem; /* Padding for smaller screens */
            opacity: 0;
            visibility: hidden;
            transition: opacity var(--transition-normal) var(--transition-timing),
                        visibility 0s linear var(--transition-normal);
        }

        .modal-backdrop.show {
            opacity: 1;
            visibility: visible;
            transition: opacity var(--transition-normal) var(--transition-timing),
                        visibility 0s linear 0s;
        }

        .modal {
            background-color: var(--card-background);
            border-radius: var(--border-radius-md);
            box-shadow: var(--shadow-xl);
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            overflow: hidden; /* Hide overflow, body will scroll */
            display: flex; /* Use flex for layout */
            flex-direction: column; /* Stack header, body, footer */
            transform: translateY(20px) scale(0.95);
            opacity: 0;
            transition: transform var(--transition-normal) var(--transition-bounce),
                        opacity var(--transition-normal) var(--transition-timing);
        }

        .modal-backdrop.show .modal {
            transform: translateY(0) scale(1);
            opacity: 1;
        }

        .modal-header {
            padding: 1.25rem 1.5rem;
            border-bottom: 1px solid var(--divider-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-shrink: 0; /* Prevent shrinking */
        }

        .modal-title {
            font-size: 1.25rem;
            font-weight: var(--font-weight-semibold);
            color: var(--text-color);
            margin: 0; /* Remove default margin */
        }

        .modal-close {
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            font-size: 1.25rem;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0.25rem;
            border-radius: var(--border-radius);
            transition: background-color var(--transition-fast) var(--transition-timing),
                        color var(--transition-fast) var(--transition-timing);
        }

        .modal-close:hover {
            background-color: var(--neutral-100);
            color: var(--text-color);
        }

        html[data-theme="dark"] .modal-close:hover {
            background-color: var(--neutral-800);
        }

        .modal-body {
            padding: 1.5rem;
            overflow-y: auto; /* Allow body content to scroll */
            flex-grow: 1; /* Take available space */
        }

        .modal-footer {
            padding: 1rem 1.5rem;
            border-top: 1px solid var(--divider-color);
            display: flex;
            align-items: center;
            justify-content: flex-end;
            gap: 0.75rem;
            background-color: var(--neutral-50); /* Footer background */
            flex-shrink: 0; /* Prevent shrinking */
        }
        html[data-theme="dark"] .modal-footer {
            background-color: hsl(var(--neutral-hue), 15%, 15%);
        }


        /* Toast Notifications */
        .toast-container {
            position: fixed;
            bottom: 1.5rem;
            right: 1.5rem;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            z-index: var(--z-toast);
            pointer-events: none; /* Container doesn't block clicks */
            max-width: 350px; /* Limit width */
        }

        .toast {
            background-color: var(--card-background);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-lg);
            padding: 1rem 1.25rem;
            display: flex;
            align-items: flex-start; /* Align items to top */
            gap: 0.75rem;
            transform: translateX(110%); /* Start off-screen */
            opacity: 0;
            transition: transform var(--transition-normal) var(--transition-bounce),
                        opacity var(--transition-normal) var(--transition-timing);
            pointer-events: auto; /* Individual toasts are clickable */
            border-left: 4px solid var(--primary-color);
            width: 100%; /* Take full width of container */
            position: relative; /* For close button positioning if needed */
        }

        .toast.show {
            transform: translateX(0);
            opacity: 1;
        }
         .toast.hide { /* State for hiding animation */
            transform: translateX(110%);
            opacity: 0;
        }

        .toast-icon {
            color: var(--primary-color);
            font-size: 1.25rem;
            flex-shrink: 0;
            margin-top: 0.125rem; /* Align with text */
            line-height: 1;
        }

        .toast-content {
            flex: 1;
            padding-right: 1.5rem; /* Space for close button */
        }

        .toast-title {
            font-weight: var(--font-weight-semibold);
            margin-bottom: 0.25rem;
            font-size: 0.875rem;
            color: var(--text-color);
        }

        .toast-message {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin: 0;
            line-height: 1.4;
        }

        .toast-close {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            font-size: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0.25rem;
            border-radius: var(--border-radius);
            transition: background-color var(--transition-fast) var(--transition-timing),
                        color var(--transition-fast) var(--transition-timing);
            flex-shrink: 0;
        }

        .toast-close:hover {
            background-color: var(--neutral-100);
            color: var(--text-color);
        }

        html[data-theme="dark"] .toast-close:hover {
            background-color: var(--neutral-800);
        }

        .toast-success {
            border-color: var(--success-color);
        }

        .toast-success .toast-icon {
            color: var(--success-color);
        }

        .toast-warning {
            border-color: var(--warning-color);
        }

        .toast-warning .toast-icon {
            color: var(--warning-color);
        }

        .toast-danger {
            border-color: var(--danger-color);
        }

        .toast-danger .toast-icon {
            color: var(--danger-color);
        }
         /* Info/Primary Toast */
        .toast-info {
            border-color: var(--primary-color);
        }
        .toast-info .toast-icon {
            color: var(--primary-color);
        }

        /* Achievements */
        .achievements-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 1rem;
        }

        .achievement {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            padding: 1rem;
            border-radius: var(--border-radius);
            background-color: var(--background-color);
            border: 1px solid var(--border-color);
            transition: transform var(--transition-normal) var(--transition-timing),
                        box-shadow var(--transition-normal) var(--transition-timing);
             position: relative; /* For tooltip positioning */
        }

        .achievement:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-md);
        }

        .achievement-icon {
            width: 3rem;
            height: 3rem;
            border-radius: var(--border-radius-full);
            background-color: var(--primary-lighter);
            color: var(--primary-color);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            margin-bottom: 0.75rem;
            transition: background-color var(--transition-normal) var(--transition-timing),
                        color var(--transition-normal) var(--transition-timing);
        }
         html[data-theme="dark"] .achievement-icon {
             background-color: var(--primary-light);
         }


        .achievement.locked .achievement-icon {
            background-color: var(--neutral-200);
            color: var(--neutral-400);
        }

        html[data-theme="dark"] .achievement.locked .achievement-icon {
            background-color: var(--neutral-800);
            color: var(--neutral-600);
        }

        .achievement-title {
            font-size: 0.875rem;
            font-weight: var(--font-weight-medium);
            margin-bottom: 0.25rem;
            color: var(--text-color);
             line-height: 1.3;
        }

        .achievement-description {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin: 0;
            line-height: 1.4;
        }

        .achievement.locked .achievement-title,
        .achievement.locked .achievement-description {
            color: var(--text-muted);
            opacity: 0.7; /* Dim locked state */
        }

        /* Streak Calendar */
        .streak-calendar {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 0.5rem;
            max-width: 300px; /* Limit width in cards */
            margin: 0 auto; /* Center */
        }
         #full-streak-calendar .streak-calendar { /* Styles for larger calendar */
            max-width: none;
            gap: 0.25rem; /* Smaller gap */
         }
         #full-streak-calendar .streak-day {
             font-size: 0.65rem; /* Smaller font */
             border-radius: var(--border-radius-sm);
         }

        .streak-day {
            aspect-ratio: 1;
            border-radius: var(--border-radius-sm);
            background-color: var(--neutral-200);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: var(--font-weight-medium);
            color: var(--text-muted);
            transition: background-color var(--transition-normal) var(--transition-timing),
                        transform var(--transition-fast) var(--transition-timing),
                        color var(--transition-normal) var(--transition-timing);
             position: relative; /* For tooltip */
             cursor: default; /* Default cursor */
        }
         .streak-day[data-tooltip]:hover { /* Add hover scale only if tooltip exists */
             transform: scale(1.1);
             z-index: var(--z-elevate); /* Bring to front */
         }

        html[data-theme="dark"] .streak-day {
            background-color: var(--neutral-800);
        }


        .streak-day.active { /* Full goal met */
            background-color: var(--success-color); /* Use success color */
            color: white;
        }

        .streak-day.partial { /* Some activity, but not goal */
            background-color: var(--warning-light); /* Use warning light */
            color: var(--warning-dark);
        }
        html[data-theme="dark"] .streak-day.partial {
             background-color: hsl(var(--warning-hue), 50%, 30%);
             color: hsl(var(--warning-hue), 80%, 80%);
        }
         .streak-day.future { /* Days in the future */
            opacity: 0.5;
            background-color: transparent;
            border: 1px dashed var(--border-color);
         }
         .streak-day.today { /* Highlight today */
             border: 2px solid var(--primary-color);
             font-weight: var(--font-weight-bold);
         }

       
        .tour-overlay.show {
            opacity: 1;
            visibility: visible;
            pointer-events: auto; /* Blocks clicks when shown */
             transition-delay: 0s;
        }

       .tour-highlight {
    position: absolute;
    border-radius: var(--border-radius);
    /* Only keep the border shadow, remove the large overlay shadow */
    box-shadow: 0 0 0 3px var(--primary-color); /* REMOVED the large overlay shadow part */
    z-index: calc(var(--z-overlay) + 1);
    pointer-events: none;
    transition: top var(--transition-slow) var(--transition-timing),
                left var(--transition-slow) var(--transition-timing),
                width var(--transition-slow) var(--transition-timing),
                height var(--transition-slow) var(--transition-timing);
    /* OPTIONAL BUT RECOMMENDED: Add initial hidden state */
    opacity: 0;
    visibility: hidden;
}

        .tour-tooltip {
            position: absolute;
            background-color: var(--card-background);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-xl);
            padding: 1.25rem;
            width: 300px;
            max-width: 90vw; /* Ensure it fits on small screens */
            z-index: calc(var(--z-overlay) + 2);
            pointer-events: auto; /* Tooltip is interactive */
             opacity: 0;
            transform: translateY(10px);
            transition: opacity var(--transition-normal) var(--transition-timing),
                        transform var(--transition-normal) var(--transition-timing);
        }
        .tour-tooltip.show {
             opacity: 1;
             transform: translateY(0);
        }

        .tour-title {
            font-size: 1rem;
            font-weight: var(--font-weight-semibold);
            margin-bottom: 0.5rem;
        }

        .tour-content {
            font-size: 0.875rem;
            margin-bottom: 1rem;
            color: var(--text-muted);
        }
         .tour-content p:last-child {
             margin-bottom: 0;
         }

        .tour-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
         .tour-step-indicator {
            font-size: 0.75rem;
            color: var(--text-light);
         }

        /* Responsive */
        @media (max-width: 1024px) {
            .sidebar {
                position: fixed; /* Change to fixed for overlay effect */
                left: 0;
                top: var(--header-height);
                height: calc(100vh - var(--header-height));
                transform: translateX(-100%); /* Start fully hidden */
                z-index: var(--z-drawer);
                box-shadow: var(--shadow-lg); /* Add shadow when overlayed */
                border-right: none; /* Remove border */
            }
            .sidebar.expanded {
                transform: translateX(0); /* Slide in */
                width: var(--sidebar-width); /* Ensure full width when expanded */
            }
            /* When sidebar is open, push content or add overlay */
            /* Option 1: Push content (might cause reflow issues) */
             /* .content-wrapper.sidebar-expanded .main-content {
                 margin-left: var(--sidebar-width);
             } */
            /* Option 2: Darken main content (simpler) */
            body.sidebar-open::after {
                 content: '';
                 position: fixed;
                 top: var(--header-height);
                 left: 0;
                 right: 0;
                 bottom: 0;
                 background-color: rgba(0,0,0,0.4);
                 z-index: calc(var(--z-drawer) - 1); /* Below sidebar */
                 opacity: 1;
                 transition: opacity var(--transition-normal) var(--transition-timing);
            }
            body:not(.sidebar-open)::after {
                 opacity: 0;
                 pointer-events: none;
            }


            .sidebar-toggle { /* Position toggle relative to header */
                 position: static; /* Remove absolute positioning */
                 /* Add a burger menu toggle in the header instead */
            }
            /* Hide the original toggle and add a burger */
             .sidebar-toggle { display: none; }
             /* Add this button to header-left in HTML */
             #menu-toggle {
                 display: inline-flex; /* Show burger on medium/small screens */
                 margin-right: 0.5rem;
             }

             .main-content {
                 margin-left: 0; /* No margin needed with overlay */
             }

            .dashboard-grid {
                grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            }
            .dashboard-grid-2col,
            .dashboard-grid-3col {
                grid-column: span 1; /* Stack columns */
            }
        }

        @media (max-width: 768px) {
            .header {
                padding: 0 1rem;
            }
            #menu-toggle { display: inline-flex; } /* Ensure burger is visible */

            .main-content {
                padding: 1.5rem 1rem;
            }

            .stats-grid {
                grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); /* Smaller cards */
            }

            .form-grid {
                grid-template-columns: 1fr; /* Stack form elements */
            }

            .logo-tagline {
                display: none;
            }
            .logo-name {
                 font-size: 1.1rem; /* Slightly smaller logo text */
            }
             .header-actions .btn span { /* Hide text on smaller buttons */
                 display: none;
             }
             .header-actions .btn {
                 padding: 0.5rem; /* Make buttons square-ish */
             }
             .header-actions .btn-icon { /* Ensure icon buttons remain same size */
                 width: 2.5rem;
                 height: 2.5rem;
             }
             .header-right {
                 gap: 0.5rem; /* Reduce gap */
             }
        }

        @media (max-width: 480px) {
            .header {
                height: auto;
                padding: 0.75rem;
                flex-direction: column; /* Stack header items */
                align-items: flex-start; /* Align left */
            }

            .header-left {
                 width: 100%;
                 justify-content: space-between; /* Space between logo and burger */
                 margin-bottom: 0.5rem; /* Space below logo/burger row */
            }
            .header-right {
                width: 100%;
                justify-content: flex-end; /* Align actions right */
                margin-top: 0; /* Remove top margin */
            }
            /* Adjust header height when stacked */
            body {
                 padding-top: 110px; /* Approximate stacked header height, adjust as needed */
            }
            .header {
                 position: fixed; /* Fix header to top */
                 top: 0;
                 left: 0;
                 right: 0;
                 z-index: var(--z-sticky);
            }
            .content-wrapper {
                 padding-top: var(--header-height); /* Adjust if header height changes drastically */
            }
             .sidebar { /* Adjust sidebar top position */
                 top: 110px; /* Match body padding top */
                 height: calc(100vh - 110px);
             }
             body.sidebar-open::after {
                 top: 110px; /* Match body padding top */
             }


            .main-content {
                padding: 1rem 0.75rem;
            }

            .card-header,
            .card-body,
            .card-footer {
                padding: 1rem;
            }
             .card-header {
                 flex-direction: column; /* Stack title and actions */
                 align-items: flex-start;
                 gap: 0.5rem;
             }
             .card-actions {
                 width: 100%;
                 justify-content: flex-end;
             }

            .toast-container {
                left: 1rem;
                right: 1rem;
                bottom: 1rem;
                max-width: calc(100% - 2rem); /* Use full width minus padding */
            }

            .modal {
                 max-width: calc(100% - 2rem); /* Ensure modal fits */
                 max-height: 85vh;
            }
            .modal-footer {
                 flex-direction: column; /* Stack buttons */
                 align-items: stretch; /* Make buttons full width */
                 gap: 0.5rem;
            }
        }

        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideInRight {
            from { transform: translateX(30px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        @keyframes slideInUp {
            from { transform: translateY(30px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        /* Apply animations directly if always needed */
        /* Or use JS to add classes */
        .animate-fade-in { animation: fadeIn 0.5s var(--transition-timing) forwards; }
        .animate-slide-in-right { animation: slideInRight 0.5s var(--transition-timing) forwards; }
        .animate-slide-in-up { animation: slideInUp 0.5s var(--transition-timing) forwards; }
        .animate-pulse { animation: pulse 2s var(--transition-timing) infinite; }

        /* Animation Delays (use with JS) */
        .delay-100 { animation-delay: 100ms; }
        .delay-200 { animation-delay: 200ms; }
        .delay-300 { animation-delay: 300ms; }
        .delay-400 { animation-delay: 400ms; }
        .delay-500 { animation-delay: 500ms; }

        /* Utility Classes */
        .hidden { display: none !important; }

    </style>
</head>
<body>
    <div class="app-container">
        <!-- Header -->
        <header class="header">
            <div class="header-left">
                 <!-- Burger Menu Toggle for Mobile -->
                <button id="menu-toggle" class="btn btn-icon btn-ghost hidden" title="Toggle menu">
                    <i class="fas fa-bars"></i>
                </button>
                <a href="#overview" class="logo" data-section="overview">
                    <div class="logo-icon">
                        <i class="fas fa-heartbeat"></i>
                    </div>
                    <div class="logo-text">
                        <span class="logo-name">HealthTrack Pro</span>
                        <span class="logo-tagline">Enterprise Health Analytics</span>
                    </div>
                </a>
            </div>
            <div class="header-right">
                <div class="header-actions">
                    <button id="tour-start" class="btn btn-sm btn-outline" data-tooltip="Start guided tour">
                        <i class="fas fa-map-marked-alt"></i>
                        <span>Tour</span>
                    </button>
                    <button id="theme-toggle" class="btn btn-icon btn-ghost" data-tooltip="Toggle theme">
                        <i class="fas fa-moon"></i> <!-- Icon will change via JS -->
                    </button>
                    <!-- Add profile/settings button if needed -->
                    <!-- <button id="profile-button" class="btn btn-icon btn-ghost" data-tooltip="Profile & Settings">
                        <i class="fas fa-user-circle"></i>
                    </button> -->
                </div>
            </div>
        </header>

        <div class="content-wrapper">
            <!-- Sidebar -->
            <aside class="sidebar" id="sidebar">
                <!-- Original toggle button - hidden on mobile -->
                <div class="sidebar-toggle" id="sidebar-toggle" title="Toggle sidebar">
                    <i class="fas fa-chevron-left"></i>
                </div>

                <div class="nav-section">
                    <div class="nav-section-title">Dashboard</div>
                    <ul class="nav-list">
                        <li class="nav-item">
                            <a href="#overview" class="nav-link active" data-section="overview">
                                <div class="nav-icon"><i class="fas fa-tachometer-alt fa-fw"></i></div>
                                <span class="nav-text">Overview</span>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="#tracking" class="nav-link" data-section="tracking">
                                <div class="nav-icon"><i class="fas fa-plus-circle fa-fw"></i></div>
                                <span class="nav-text">Track Health</span>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="#history" class="nav-link" data-section="history">
                                <div class="nav-icon"><i class="fas fa-history fa-fw"></i></div>
                                <span class="nav-text">History</span>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="#goals" class="nav-link" data-section="goals">
                                <div class="nav-icon"><i class="fas fa-bullseye fa-fw"></i></div>
                                <span class="nav-text">Goals</span>
                            </a>
                        </li>
                    </ul>
                </div>

                <div class="nav-section">
                    <div class="nav-section-title">Analytics</div>
                    <ul class="nav-list">
                        <li class="nav-item">
                            <a href="#reports" class="nav-link" data-section="reports">
                                <div class="nav-icon"><i class="fas fa-chart-line fa-fw"></i></div>
                                <span class="nav-text">Reports</span>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="#insights" class="nav-link" data-section="insights">
                                <div class="nav-icon"><i class="fas fa-lightbulb fa-fw"></i></div>
                                <span class="nav-text">Insights</span>
                            </a>
                        </li>
                    </ul>
                </div>

                <div class="nav-section">
                    <div class="nav-section-title">Achievements</div>
                    <ul class="nav-list">
                        <li class="nav-item">
                            <a href="#achievements" class="nav-link" data-section="achievements">
                                <div class="nav-icon"><i class="fas fa-trophy fa-fw"></i></div>
                                <span class="nav-text">Badges</span>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a href="#streaks" class="nav-link" data-section="streaks">
                                <div class="nav-icon"><i class="fas fa-fire fa-fw"></i></div>
                                <span class="nav-text">Streaks</span>
                            </a>
                        </li>
                    </ul>
                </div>

                <div class="sidebar-footer">
                    <div class="sidebar-footer-text">
                        &copy; <span id="current-year"></span> HealthTrack Pro
                    </div>
                     <!-- Can add a settings link or other footer items here -->
                     <a href="#settings" class="nav-link btn-icon btn-ghost" data-section="settings" data-tooltip="Settings">
                         <i class="fas fa-cog fa-fw"></i>
                     </a>
                </div>
            </aside>

            <!-- Main Content -->
            <main class="main-content">
                <!-- Overview Section -->
                <section id="overview" class="section active">
                    <h1 class="animate-fade-in">Dashboard Overview</h1>

                    <div class="stats-grid animate-slide-in-up">
                        <div class="stat-card success delay-100">
                            <div class="stat-header">
                                <div class="stat-title">Daily Steps</div>
                                <div class="stat-icon">
                                    <i class="fas fa-walking fa-fw"></i>
                                </div>
                            </div>
                            <div class="stat-value" id="overview-steps">0</div>
                            <div class="stat-comparison">
                                <span>Goal: <span id="overview-steps-goal">10,000</span></span>
                                <span class="stat-change positive" id="overview-steps-change">
                                    <i class="fas fa-arrow-up fa-fw"></i> <span>--%</span>
                                </span>
                            </div>
                        </div>

                        <div class="stat-card primary delay-200">
                            <div class="stat-header">
                                <div class="stat-title">Sleep Duration</div>
                                <div class="stat-icon">
                                    <i class="fas fa-bed fa-fw"></i>
                                </div>
                            </div>
                            <div class="stat-value" id="overview-sleep">0 hrs</div>
                            <div class="stat-comparison">
                                <span>Goal: <span id="overview-sleep-goal">8 hrs</span></span>
                                <span class="stat-change negative" id="overview-sleep-change">
                                    <i class="fas fa-arrow-down fa-fw"></i> <span>--%</span>
                                </span>
                            </div>
                        </div>

                        <div class="stat-card warning delay-300">
                            <div class="stat-header">
                                <div class="stat-title">Calorie Intake</div>
                                <div class="stat-icon">
                                    <i class="fas fa-utensils fa-fw"></i>
                                </div>
                            </div>
                            <div class="stat-value" id="overview-calories">0</div>
                            <div class="stat-comparison">
                                <span>Goal: <span id="overview-calories-goal">2,000</span></span>
                                <span class="stat-change neutral" id="overview-calories-change"> <!-- Default neutral -->
                                    <i class="fas fa-minus fa-fw"></i> <span>--%</span>
                                </span>
                            </div>
                        </div>

                        <div class="stat-card primary delay-400">
                            <div class="stat-header">
                                <div class="stat-title">Current Streak</div>
                                <div class="stat-icon">
                                    <i class="fas fa-fire fa-fw"></i>
                                </div>
                            </div>
                            <div class="stat-value" id="overview-streak">0 days</div>
                            <div class="stat-comparison">
                                <span>Best: <span id="overview-best-streak">0 days</span></span>
                                <span class="stat-change positive" id="overview-streak-change">
                                    <!-- Content updated by JS -->
                                </span>
                            </div>
                        </div>
                    </div>

                    <div class="dashboard-grid">
                        <div class="card dashboard-grid-2col animate-slide-in-up delay-200">
                            <div class="card-header">
                                <h3 class="card-title">
                                    <span class="card-title-icon"><i class="fas fa-chart-line fa-fw"></i></span>
                                    Weekly Progress
                                </h3>
                                <div class="card-actions">
                                    <div class="btn-group" id="weekly-progress-toggle">
                                        <button class="btn btn-sm btn-ghost time-range active" data-range="week">Week</button>
                                        <button class="btn btn-sm btn-ghost time-range" data-range="month">Month</button>
                                    </div>
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="chart-container">
                                    <canvas id="weekly-progress-chart"></canvas>
                                </div>
                            </div>
                        </div>

                        <div class="card animate-slide-in-up delay-300">
                            <div class="card-header">
                                <h3 class="card-title">
                                    <span class="card-title-icon"><i class="fas fa-lightbulb fa-fw"></i></span>
                                    Health Tip
                                </h3>
                            </div>
                            <div class="card-body">
                                <div id="health-tip-container">
                                    <!-- Tip loaded here -->
                                    <div class="alert alert-primary">
                                         <div class="alert-icon"><i class="fas fa-info-circle fa-fw"></i></div>
                                         <div class="alert-content">
                                             <div class="alert-title">Daily Tip</div>
                                             <p class="alert-message" id="tip-text">Loading your personalized health tip...</p>
                                         </div>
                                    </div>
                                </div>
                                <div class="progress-label">
                                    <span>Today's Goal Completion</span>
                                    <span id="goal-completion-percentage">0%</span>
                                </div>
                                <div class="progress">
                                    <div class="progress-bar" id="goal-completion-bar" style="width: 0%"></div>
                                </div>
                            </div>
                        </div>

                        <div class="card animate-slide-in-up delay-400">
                            <div class="card-header">
                                <h3 class="card-title">
                                    <span class="card-title-icon"><i class="fas fa-calendar-alt fa-fw"></i></span>
                                    Recent Activity
                                </h3>
                            </div>
                            <div class="card-body">
                                <div class="streak-calendar" id="streak-calendar">
                                    <!-- Populated by JS: 7 days -->
                                </div>
                            </div>
                            <div class="card-footer">
                                <span>Current streak: <strong id="current-streak-display">0 days</strong></span>
                                <button class="btn btn-sm btn-outline nav-link-btn" data-section="streaks">
                                    <i class="fas fa-calendar-alt fa-fw"></i>
                                    View Streaks
                                </button>
                            </div>
                        </div>

                        <div class="card animate-slide-in-up delay-500">
                            <div class="card-header">
                                <h3 class="card-title">
                                    <span class="card-title-icon"><i class="fas fa-trophy fa-fw"></i></span>
                                    Recent Achievements
                                </h3>
                            </div>
                            <div class="card-body">
                                <div class="achievements-grid" id="recent-achievements">
                                    <!-- Populated by JS: Top 3 recent -->
                                    <div class="table-empty" id="recent-achievements-empty">
                                        <i class="fas fa-award fa-fw"></i>
                                        <p>Keep tracking to earn badges!</p>
                                    </div>
                                </div>
                            </div>
                            <div class="card-footer">
                                <button class="btn btn-sm btn-outline nav-link-btn" data-section="achievements">
                                    <i class="fas fa-award fa-fw"></i>
                                    View All Badges
                                </button>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Track Health Section -->
                <section id="tracking" class="section">
                    <h1>Track Your Health</h1>

                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">
                                <span class="card-title-icon"><i class="fas fa-plus-circle fa-fw"></i></span>
                                Add Today's Data
                            </h3>
                            <div class="card-actions">
                                <span id="today-date" class="badge badge-outline"></span>
                            </div>
                        </div>
                        <form id="tracking-form">
                            <div class="card-body">
                                <div class="form-grid">
                                    <div class="form-group">
                                        <label for="steps" class="form-label">
                                            <span class="form-label-icon"><i class="fas fa-walking fa-fw"></i></span>
                                            Add Steps
                                        </label>
                                        <input type="number" id="steps" class="form-control" placeholder="e.g., 3000" min="0" step="1">
                                        <div class="form-error" data-for="steps">Please enter a valid positive number</div>
                                        <div class="form-hint">Enter steps taken in this session</div>
                                    </div>

                                    <div class="form-group">
                                        <label for="sleep" class="form-label">
                                            <span class="form-label-icon"><i class="fas fa-bed fa-fw"></i></span>
                                            Set Sleep (hours)
                                        </label>
                                        <input type="number" id="sleep" class="form-control" placeholder="e.g., 7.5" min="0" max="24" step="0.1">
                                        <div class="form-error" data-for="sleep">Please enter hours between 0 and 24</div>
                                        <div class="form-hint">Enter total sleep duration for the *previous* night</div>
                                    </div>

                                    <div class="form-group">
                                        <label for="calories" class="form-label">
                                            <span class="form-label-icon"><i class="fas fa-utensils fa-fw"></i></span>
                                            Add Calorie Intake
                                        </label>
                                        <input type="number" id="calories" class="form-control" placeholder="e.g., 500" min="0" step="1">
                                        <div class="form-error" data-for="calories">Please enter a valid positive number</div>
                                        <div class="form-hint">Enter calories consumed in this meal/snack</div>
                                    </div>
                                </div>
                            </div>
                             <div class="card-footer">
                                 <div class="btn-group">
                                    <button type="submit" id="save-data" class="btn btn-success">
                                        <i class="fas fa-plus fa-fw"></i>
                                        Add Entries
                                    </button>
                                    <button type="button" id="clear-today" class="btn btn-warning">
                                        <i class="fas fa-eraser fa-fw"></i>
                                        Clear Today's Entries
                                    </button>
                                </div>
                             </div>
                        </form>
                    </div>

                    <div class="dashboard-grid">
                        <div class="card dashboard-grid-2col">
                            <div class="card-header">
                                <h3 class="card-title">
                                    <span class="card-title-icon"><i class="fas fa-chart-pie fa-fw"></i></span> <!-- Changed icon -->
                                    Today's Goal Progress
                                </h3>
                            </div>
                            <div class="card-body">
                                <div class="chart-container" style="height: 280px;"> <!-- Adjusted height -->
                                    <canvas id="today-progress-chart"></canvas>
                                </div>
                            </div>
                        </div>

                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">
                                    <span class="card-title-icon"><i class="fas fa-clipboard-list fa-fw"></i></span>
                                    Today's Entries Log
                                </h3>
                            </div>
                            <div class="card-body" style="padding: 0;"> <!-- Remove padding for table container -->
                                <div class="table-container" style="border: none; border-radius: 0; margin-bottom: 0;"> <!-- Remove border/margin -->
                                    <table class="table" id="today-entries-table">
                                        <thead>
                                            <tr>
                                                <th>Time</th>
                                                <th>Type</th>
                                                <th>Value</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="today-entries-tbody">
                                            <!-- Populated by JS -->
                                            <tr class="placeholder hidden">
                                                 <td colspan="4" class="table-empty" id="today-entries-empty">
                                                    <i class="fas fa-inbox fa-fw"></i>
                                                    <p>No entries recorded yet today</p>
                                                 </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- History Section -->
                <section id="history" class="section">
                    <h1>History</h1>

                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">
                                <span class="card-title-icon"><i class="fas fa-history fa-fw"></i></span>
                                Past Records
                            </h3>
                            <div class="card-actions">
                                <div class="form-group" style="margin-bottom: 0;"> <!-- Remove margin from form group -->
                                    <input type="text" id="history-search" class="form-control form-control-sm" placeholder="Search by date (YYYY-MM-DD)...">
                                </div>
                            </div>
                        </div>
                        <div class="card-body" style="padding: 0;">
                            <div class="table-container" style="border: none; border-radius: 0; margin-bottom: 0;">
                                <table class="table" id="history-table">
                                    <thead>
                                        <tr>
                                            <th>Date</th>
                                            <th>Total Steps</th>
                                            <th>Sleep (hrs)</th>
                                            <th>Total Calories</th>
                                            <th>Goal Status</th>
                                            <!-- <th>Actions</th> --> <!-- Actions might be complex, view details? -->
                                        </tr>
                                    </thead>
                                    <tbody id="history-tbody">
                                        <!-- Populated by JS -->
                                         <tr class="placeholder hidden">
                                             <td colspan="5" class="table-empty" id="history-empty">
                                                <i class="fas fa-inbox fa-fw"></i>
                                                <p>No past records found</p>
                                             </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <div class="card-footer">
                             <!-- Add Pagination Controls here if needed -->
                             <div><!-- Placeholder for pagination --></div>
                            <div class="btn-group">
                                <button id="export-csv" class="btn btn-sm btn-outline">
                                    <i class="fas fa-file-csv fa-fw"></i>
                                    Export CSV
                                </button>
                                <!-- <button id="export-pdf" class="btn btn-sm btn-outline" disabled>
                                    <i class="fas fa-file-pdf fa-fw"></i>
                                    Export PDF
                                </button> -->
                                <button id="print-history" class="btn btn-sm btn-outline">
                                    <i class="fas fa-print fa-fw"></i>
                                    Print View
                                </button>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Goals Section -->
                <section id="goals" class="section">
                    <h1>Set Your Goals</h1>

                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">
                                <span class="card-title-icon"><i class="fas fa-bullseye fa-fw"></i></span>
                                Current Health Goals
                            </h3>
                        </div>
                         <form id="goals-form">
                            <div class="card-body">
                                <div class="form-grid">
                                    <div class="form-group">
                                        <label for="steps-goal" class="form-label">
                                            <span class="form-label-icon"><i class="fas fa-walking fa-fw"></i></span>
                                            Daily Steps Goal
                                        </label>
                                        <input type="number" id="steps-goal" name="steps" class="form-control" placeholder="e.g., 10000" min="0" step="100">
                                        <div class="form-error" data-for="steps-goal">Please enter a valid positive number</div>
                                        <div class="form-hint">Your daily target for total steps</div>
                                    </div>

                                    <div class="form-group">
                                        <label for="sleep-goal" class="form-label">
                                            <span class="form-label-icon"><i class="fas fa-bed fa-fw"></i></span>
                                            Nightly Sleep Goal (hrs)
                                        </label>
                                        <input type="number" id="sleep-goal" name="sleep" class="form-control" placeholder="e.g., 8" min="0" max="24" step="0.1">
                                        <div class="form-error" data-for="sleep-goal">Please enter hours between 0 and 24</div>
                                        <div class="form-hint">Your target for nightly sleep duration</div>
                                    </div>

                                    <div class="form-group">
                                        <label for="calories-goal" class="form-label">
                                            <span class="form-label-icon"><i class="fas fa-utensils fa-fw"></i></span>
                                            Daily Calorie Goal (Max)
                                        </label>
                                        <input type="number" id="calories-goal" name="calories" class="form-control" placeholder="e.g., 2000" min="0" step="50">
                                        <div class="form-error" data-for="calories-goal">Please enter a valid positive number</div>
                                        <div class="form-hint">Your target maximum daily calorie intake</div>
                                    </div>
                                </div>
                            </div>
                            <div class="card-footer">
                                <button type="submit" id="save-goals" class="btn btn-primary">
                                    <i class="fas fa-save fa-fw"></i>
                                    Update Goals
                                </button>
                            </div>
                        </form>
                    </div>

                    <div class="dashboard-grid">
                         <!-- Optional Goal Distribution Chart - might not be very useful -->
                        <!-- <div class="card"> ... </div> -->

                        <div class="card dashboard-grid-2col"> <!-- Span 2 columns -->
                            <div class="card-header">
                                <h3 class="card-title">
                                    <span class="card-title-icon"><i class="fas fa-history fa-fw"></i></span>
                                    Goal Change History
                                </h3>
                            </div>
                            <div class="card-body" style="padding: 0;">
                                <div class="table-container" style="border: none; border-radius: 0; margin-bottom: 0;">
                                    <table class="table" id="goals-history-table">
                                        <thead>
                                            <tr>
                                                <th>Date Changed</th>
                                                <th>Steps Goal</th>
                                                <th>Sleep Goal (hrs)</th>
                                                <th>Calorie Goal</th>
                                            </tr>
                                        </thead>
                                        <tbody id="goals-history-tbody">
                                            <!-- Populated by JS -->
                                             <tr class="placeholder hidden">
                                                 <td colspan="4" class="table-empty" id="goals-history-empty">
                                                    <i class="fas fa-inbox fa-fw"></i>
                                                    <p>No goal changes recorded yet</p>
                                                 </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Reports Section -->
                <section id="reports" class="section">
                    <h1>Reports & Analytics</h1>

                    <div class="dashboard-grid">
                        <div class="card dashboard-grid-2col">
                            <div class="card-header">
                                <h3 class="card-title">
                                    <span class="card-title-icon"><i class="fas fa-chart-line fa-fw"></i></span>
                                    Health Trends
                                </h3>
                                <div class="card-actions">
                                    <div class="btn-group" id="trends-chart-toggle">
                                        <button class="btn btn-sm btn-ghost trend-range active" data-range="week">Week</button>
                                        <button class="btn btn-sm btn-ghost trend-range" data-range="month">Month</button>
                                        <button class="btn btn-sm btn-ghost trend-range" data-range="year">Year</button>
                                    </div>
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="chart-container" style="height: 350px;"> <!-- Taller chart -->
                                    <canvas id="health-trends-chart"></canvas>
                                </div>
                            </div>
                        </div>

                        <div class="card">
                            <div class="card-header">
                                <h3 class="card-title">
                                    <span class="card-title-icon"><i class="fas fa-calendar-check fa-fw"></i></span>
                                    Goal Completion Rate
                                </h3>
                                <div class="card-actions">
                                     <select id="goal-completion-period" class="form-control form-control-sm" style="max-width: 120px;">
                                         <option value="week">Last 7 Days</option>
                                         <option value="month">Last 30 Days</option>
                                         <option value="year">Last Year</option>
                                     </select>
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="chart-container" style="height: 350px;">
                                    <canvas id="goal-completion-chart"></canvas>
                                </div>
                            </div>
                        </div>

                        <div class="card dashboard-grid-3col">
                            <div class="card-header">
                                <h3 class="card-title">
                                    <span class="card-title-icon"><i class="fas fa-file-export fa-fw"></i></span>
                                    Generate Custom Report
                                </h3>
                            </div>
                            <form id="report-generation-form">
                                <div class="card-body">
                                    <div class="form-grid">
                                        <div class="form-group">
                                            <label for="report-start-date" class="form-label">
                                                <span class="form-label-icon"><i class="fas fa-calendar-alt fa-fw"></i></span>
                                                Start Date
                                            </label>
                                            <input type="date" id="report-start-date" class="form-control" required>
                                            <div class="form-error" data-for="report-start-date">Start date required</div>
                                        </div>

                                        <div class="form-group">
                                            <label for="report-end-date" class="form-label">
                                                <span class="form-label-icon"><i class="fas fa-calendar-alt fa-fw"></i></span>
                                                End Date
                                            </label>
                                            <input type="date" id="report-end-date" class="form-control" required>
                                            <div class="form-error" data-for="report-end-date">End date required</div>
                                        </div>

                                        <div class="form-group">
                                            <label for="report-type" class="form-label">
                                                <span class="form-label-icon"><i class="fas fa-file-alt fa-fw"></i></span>
                                                Report Type
                                            </label>
                                            <select id="report-type" class="form-control">
                                                <option value="summary">Daily Summary</option>
                                                <option value="detailed">Detailed Entries (CSV)</option>
                                                <option value="trends">Trends Overview</option>
                                                <option value="goals">Goal Completion</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                                <div class="card-footer">
                                    <button type="submit" id="generate-report" class="btn btn-primary">
                                        <i class="fas fa-cogs fa-fw"></i> <!-- Changed icon -->
                                        Generate Report
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </section>

                <!-- Insights Section -->
                <section id="insights" class="section">
                    <h1>Health Insights</h1>

                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">
                                <span class="card-title-icon"><i class="fas fa-lightbulb fa-fw"></i></span>
                                Personalized Insights & Suggestions
                            </h3>
                            <div class="card-actions">
                                <button id="refresh-insights" class="btn btn-sm btn-outline" data-tooltip="Refresh Insights">
                                    <i class="fas fa-sync-alt fa-fw"></i>
                                </button>
                            </div>
                        </div>
                        <div class="card-body">
                            <div id="insights-container" class="insights-list">
                                <!-- Populated by JS -->
                                <div class="alert alert-primary" id="insights-loading">
                                    <div class="alert-icon"><i class="fas fa-spinner fa-spin fa-fw"></i></div>
                                    <div class="alert-content">
                                        <p class="alert-message">Analyzing your data for insights...</p>
                                    </div>
                                </div>
                                 <div class="alert alert-secondary hidden" id="insights-empty">
                                    <div class="alert-icon"><i class="fas fa-info-circle fa-fw"></i></div>
                                    <div class="alert-content">
                                        <p class="alert-message">Not enough data yet for personalized insights. Keep tracking your health!</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Achievements Section -->
                <section id="achievements" class="section">
                    <h1>Achievements & Badges</h1>

                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">
                                <span class="card-title-icon"><i class="fas fa-trophy fa-fw"></i></span>
                                Your Achievements
                            </h3>
                             <div class="card-actions">
                                 <span id="achievements-count" class="badge badge-primary">0 / 0</span>
                             </div>
                        </div>
                        <div class="card-body">
                            <div class="achievements-grid" id="all-achievements">
                                <!-- Populated by JS -->
                            </div>
                        </div>
                         <div class="card-footer">
                            <span>Keep tracking to unlock more badges!</span>
                        </div>
                    </div>
                </section>

                <!-- Streaks Section -->
                <section id="streaks" class="section">
                    <h1>Activity Streaks</h1>

                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">
                                <span class="card-title-icon"><i class="fas fa-fire fa-fw"></i></span>
                                Goal Consistency Streaks
                            </h3>
                            <div class="card-actions">
                                <span class="badge badge-outline">Current: <strong id="streaks-current-display">0</strong> days</span>
                                <span class="badge badge-outline">Best: <strong id="streaks-best-display">0</strong> days</span>
                            </div>
                        </div>
                        <div class="card-body">
                             <p class="text-muted text-center">Calendar view showing days where you met all primary goals (Steps, Sleep, Calories). Hover over a day for details.</p>
                             <div id="full-streak-calendar-container">
                                 <!-- Controls for year/month selection can go here -->
                                 <div class="streak-calendar" id="full-streak-calendar">
                                    <!-- Populated by JS: e.g., current month or year -->
                                 </div>
                             </div>
                        </div>
                         <div class="card-footer">
                            <span>A day turns <span class="badge badge-success">Green</span> when all goals are met!</span>
                        </div>
                    </div>
                </section>

                <!-- Settings Section (Placeholder) -->
                <section id="settings" class="section">
                     <h1>Settings</h1>
                      <div class="card">
                         <div class="card-header">
                             <h3 class="card-title">
                                 <span class="card-title-icon"><i class="fas fa-cog fa-fw"></i></span>
                                 Application Settings
                             </h3>
                         </div>
                         <div class="card-body">
                             <div class="form-group">
                                 <label class="form-label">Theme Preference</label>
                                 <div class="btn-group">
                                     <button class="btn btn-sm btn-outline theme-setting" data-theme-value="light"><i class="fas fa-sun fa-fw"></i> Light</button>
                                     <button class="btn btn-sm btn-outline theme-setting" data-theme-value="dark"><i class="fas fa-moon fa-fw"></i> Dark</button>
                                     <button class="btn btn-sm btn-outline theme-setting" data-theme-value="system"><i class="fas fa-desktop fa-fw"></i> System</button>
                                 </div>
                                 <div class="form-hint">Choose your preferred color theme.</div>
                             </div>
                             <hr style="margin: 1.5rem 0; border-color: var(--divider-color);">
                             <div class="form-group">
                                 <label class="form-label">Data Management</label>
                                 <div class="btn-group">
                                     <button id="export-all-data" class="btn btn-sm btn-outline-primary"><i class="fas fa-download fa-fw"></i> Export All Data (JSON)</button>
                                     <button id="import-data" class="btn btn-sm btn-outline-primary"><i class="fas fa-upload fa-fw"></i> Import Data (JSON)</button>
                                     <button id="reset-app-data" class="btn btn-sm btn-outline-danger"><i class="fas fa-trash-alt fa-fw"></i> Reset All Data</button>
                                 </div>
                                 <div class="form-hint text-danger">Warning: Resetting data cannot be undone.</div>
                                 <input type="file" id="import-file-input" accept=".json" style="display: none;">
                             </div>
                         </div>
                     </div>
                </section>

            </main>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toast-container">
        <!-- Toasts injected here -->
    </div>

    <!-- Modals -->
    <div class="modal-backdrop hidden" id="entry-detail-modal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Edit Entry</h3>
                <button class="modal-close" data-dismiss="modal" aria-label="Close modal">
                    <i class="fas fa-times fa-fw"></i>
                </button>
            </div>
            <form id="edit-entry-form">
                 <div class="modal-body" id="entry-detail-content">
                    <!-- Form fields populated by JS -->
                    <input type="hidden" id="edit-entry-id">
                    <input type="hidden" id="edit-entry-date">
                    <div class="form-group">
                        <label id="edit-entry-label" class="form-label"></label>
                        <input type="number" id="edit-entry-value" class="form-control" required min="0">
                         <div class="form-error" data-for="edit-entry-value">Invalid value</div>
                    </div>
                     <p class="text-muted" id="edit-entry-time"></p>
                 </div>
                 <div class="modal-footer">
                     <button type="button" class="btn btn-danger" id="delete-entry">
                        <i class="fas fa-trash-alt fa-fw"></i> Delete Entry
                     </button>
                     <button type="button" class="btn btn-outline" data-dismiss="modal">Cancel</button>
                     <button type="submit" class="btn btn-primary" id="save-entry-changes">
                        <i class="fas fa-save fa-fw"></i> Save Changes
                     </button>
                 </div>
            </form>
        </div>
    </div>

     <!-- Confirmation Modal -->
     <div class="modal-backdrop hidden" id="confirmation-modal">
        <div class="modal" style="max-width: 400px;"> <!-- Smaller modal -->
            <div class="modal-header">
                <h3 class="modal-title" id="confirmation-title">Are you sure?</h3>
                <button class="modal-close" data-dismiss="modal" aria-label="Close modal">
                    <i class="fas fa-times fa-fw"></i>
                </button>
            </div>
             <div class="modal-body" id="confirmation-message">
                This action cannot be undone.
             </div>
             <div class="modal-footer">
                 <button type="button" class="btn btn-outline" data-dismiss="modal">Cancel</button>
                 <button type="button" class="btn btn-danger" id="confirm-action-button">Confirm</button>
             </div>
        </div>
    </div>

    <!-- Tour Overlay Structure -->
     <div class="tour-overlay" id="tour-overlay"></div>
     <div class="tour-highlight" id="tour-highlight"></div>
     <div class="tour-tooltip hidden" id="tour-tooltip">
         <h4 class="tour-title" id="tour-tooltip-title">Tooltip Title</h4>
         <div class="tour-content" id="tour-tooltip-content">
             Tooltip content goes here.
         </div>
         <div class="tour-actions">
             <span class="tour-step-indicator" id="tour-step-indicator">Step 1 / 5</span>
             <div class="btn-group">
                 <button class="btn btn-sm btn-ghost" id="tour-skip">Skip Tour</button>
                 <button class="btn btn-sm btn-outline" id="tour-prev">Previous</button>
                 <button class="btn btn-sm btn-primary" id="tour-next">Next</button>
             </div>
         </div>
     </div>


    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@2.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>

    <!-- Main Script -->
    <script>
        // ===== Strict Mode & IIFE =====
        "use strict";
        (function() {

            // ===== DOM Element References =====
            const sidebar = document.getElementById('sidebar');
            const sidebarToggle = document.getElementById('sidebar-toggle');
            const menuToggle = document.getElementById('menu-toggle'); // Mobile burger
            const themeToggle = document.getElementById('theme-toggle');
            const navLinks = document.querySelectorAll('.nav-link');
            const sections = document.querySelectorAll('.main-content .section');
            const currentYearSpan = document.getElementById('current-year');
            const toastContainer = document.getElementById('toast-container');
            const todayDateSpan = document.getElementById('today-date');
            const trackingForm = document.getElementById('tracking-form');
            const goalsForm = document.getElementById('goals-form');
            const entryDetailModal = document.getElementById('entry-detail-modal');
            const confirmationModal = document.getElementById('confirmation-modal');
            const reportGenerationForm = document.getElementById('report-generation-form');

            // Chart instances (to be initialized later)
            let weeklyProgressChart = null;
            let todayProgressChart = null;
            // let goalsDistributionChart = null; // Optional
            let healthTrendsChart = null;
            let goalCompletionChart = null;

             // Chart default colors (using CSS variables)
            const getCssVar = (varName) => getComputedStyle(document.documentElement).getPropertyValue(varName).trim();
            const chartColors = {
                primary: getCssVar('--primary-color'),
                success: getCssVar('--success-color'),
                warning: getCssVar('--warning-color'),
                danger: getCssVar('--danger-color'),
                text: getCssVar('--text-color'),
                textMuted: getCssVar('--text-muted'),
                grid: getCssVar('--border-color'),
            };


            // ===== Application State =====
             const APP_STORAGE_KEY = 'healthTrackProData_v1'; // Versioning key
             let appData = {
                userSettings: {
                    theme: 'system', // 'light', 'dark', 'system'
                    sidebarCollapsed: false,
                    lastVisitedSection: 'overview'
                },
                goals: { steps: 10000, sleep: 8, calories: 2000 },
                goalsHistory: [], // { date: 'YYYY-MM-DD', goals: { ... } }
                dailyRecords: {}, // { 'YYYY-MM-DD': { date: '...', totalSteps: 0, sleepDuration: null, totalCalories: 0, entries: [], goalsMet: false } }
                achievements: [], // [{ id: '...', dateEarned: 'YYYY-MM-DD' }]
                streaks: { current: 0, best: 0, lastDate: null } // lastDate helps track consistency
             };

            // ===== Health Tips (Continued from prompt) =====
            const healthTips = [
                {
                    condition: (r, g) => r && r.sleepDuration !== null && r.sleepDuration > 0 && r.sleepDuration < g.sleep * 0.7, // Less than 70% of goal
                    getTip: (r, g) => ({
                        text: `Low sleep detected (${r.sleepDuration.toFixed(1)} hrs vs goal of ${g.sleep} hrs). Aim for an earlier bedtime tonight or a short nap if possible. Avoid caffeine late in the day.`,
                        type: 'warning'
                    })
                },
                {
                    condition: (r, g) => r && r.totalCalories !== null && g.calories > 0 && r.totalCalories > g.calories * 1.5, // Over 150% of goal
                    getTip: (r, g) => ({
                        text: `Calorie intake (${r.totalCalories} kcal) significantly exceeded your goal (${g.calories} kcal). Consider lighter meals for the rest of the day and focus on hydration.`,
                        type: 'warning'
                    })
                },
                {
                    condition: (r, g) => r && r.totalSteps !== null && r.totalSteps > 0 && r.totalSteps < g.steps * 0.5, // Less than 50% of step goal
                    getTip: (r, g) => ({
                        text: `You're a bit behind on your step goal (${r.totalSteps} steps vs ${g.steps}). Try incorporating a short walk into your afternoon or evening!`,
                        type: 'info'
                    })
                },
                 {
                    condition: (r, g) => r && r.totalSteps !== null && r.totalSteps >= g.steps && r.sleepDuration !== null && r.sleepDuration >= g.sleep && r.totalCalories !== null && r.totalCalories <= g.calories,
                    getTip: (r, g) => ({
                        text: `Fantastic job meeting all your primary goals today! Keep up the great work maintaining a healthy balance.`,
                        type: 'success'
                    })
                },
                {
                    condition: (r, g, streak) => streak && streak.current > 0 && streak.current % 5 === 0, // Every 5 days of streak
                     getTip: (r, g, streak) => ({
                        text: `Awesome ${streak.current}-day streak! Consistency is key to building healthy habits. Keep the momentum going!`,
                        type: 'success'
                    })
                },
                 // Default/Fallback tip
                {
                    condition: () => true, // Always matches if others don't
                    getTip: () => ({
                        text: `Remember to stay hydrated! Drinking enough water throughout the day supports overall health and energy levels.`,
                        type: 'primary'
                    })
                }
            ];


            // ===== Achievement Definitions (Continued from prompt) =====
            const achievementDefinitions = [
                // Steps
                { id: 'steps-1k', title: 'First Thousand', description: 'Record 1,000 steps in a day', icon: 'shoe-prints', condition: r => r.totalSteps >= 1000 },
                { id: 'steps-5k', title: 'Step Starter', description: 'Record 5,000 steps in a day', icon: 'walking', condition: r => r.totalSteps >= 5000 },
                { id: 'steps-10k', title: 'Daily Walker', description: 'Record 10,000 steps in a day', icon: 'hiking', condition: r => r.totalSteps >= 10000 },
                { id: 'steps-15k', title: 'Power Walker', description: 'Record 15,000 steps in a day', icon: 'running', condition: r => r.totalSteps >= 15000 },
                // Sleep
                { id: 'sleep-7', title: 'Good Night', description: 'Sleep 7+ hours', icon: 'moon', condition: r => r.sleepDuration !== null && r.sleepDuration >= 7 },
                { id: 'sleep-8', title: 'Well Rested', description: 'Sleep 8+ hours', icon: 'bed', condition: r => r.sleepDuration !== null && r.sleepDuration >= 8 },
                { id: 'sleep-consistent-7', title: 'Sleep Consistency', description: 'Sleep 7+ hours for 7 days straight', icon: 'calendar-check', condition: (r, history) => checkConsecutiveDays(history, d => d.sleepDuration !== null && d.sleepDuration >= 7, 7), requiresHistory: true },
                // Calories (Assuming goal is a max limit)
                { id: 'calories-on-target', title: 'Mindful Eater', description: 'Stay within calorie goal for a day', icon: 'apple-alt', condition: (r, _, g) => r.totalCalories !== null && r.totalCalories > 0 && r.totalCalories <= g.calories },
                { id: 'calories-consistent-7', title: 'Consistent Nutrition', description: 'Stay within calorie goal for 7 days straight', icon: 'balance-scale-right', condition: (r, history, g) => checkConsecutiveDays(history, d => d.totalCalories !== null && d.totalCalories > 0 && d.totalCalories <= g.calories, 7), requiresHistory: true },
                // Streaks
                { id: 'streak-3', title: 'Getting Started', description: 'Maintain a 3-day goal streak', icon: 'star', condition: (r, h, g, s) => s.current >= 3 },
                { id: 'streak-7', title: 'Week Warrior', description: 'Maintain a 7-day goal streak', icon: 'calendar-week', condition: (r, h, g, s) => s.current >= 7 },
                { id: 'streak-14', title: 'Fortnight Flex', description: 'Maintain a 14-day goal streak', icon: 'medal', condition: (r, h, g, s) => s.current >= 14 },
                { id: 'streak-30', title: 'Monthly Master', description: 'Maintain a 30-day goal streak', icon: 'fire-alt', condition: (r, h, g, s) => s.current >= 30 },
                // Combination / Overall
                { id: 'goals-all-day', title: 'Triple Threat', description: 'Meet step, sleep & calorie goals in one day', icon: 'award', condition: (r, _, g) => goalsMetForDay(r, g) },
                { id: 'first-entry', title: 'Welcome Aboard!', description: 'Log your first health entry', icon: 'door-open', condition: (r, history) => Object.keys(history).length > 0, requiresHistory: true },
                { id: 'week-logged', title: 'Consistent Logger', description: 'Log data for 7 consecutive days', icon: 'clipboard-list', condition: (r, history) => checkConsecutiveDays(history, d => true, 7), requiresHistory: true },
            ];

            // ===== Utility Functions =====

            /** Formats a Date object or string into YYYY-MM-DD */
            const formatDate = (date = new Date()) => {
                const d = new Date(date);
                const year = d.getFullYear();
                const month = String(d.getMonth() + 1).padStart(2, '0');
                const day = String(d.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            };

            /** Formats a Date object into a readable string (e.g., Mon, Aug 19) */
            const formatReadableDate = (date = new Date()) => {
                return new Date(date).toLocaleDateString(undefined, { weekday: 'short', month: 'short', day: 'numeric' });
            };

            /** Formats time (e.g., 14:30) */
             const formatTime = (date = new Date()) => {
                return new Date(date).toLocaleTimeString(undefined, { hour: '2-digit', minute: '2-digit', hour12: false });
            };

             /** Gets the date string for yesterday */
             const getYesterdayDate = () => {
                const yesterday = new Date();
                yesterday.setDate(yesterday.getDate() - 1);
                return formatDate(yesterday);
             };

            /** Validates form input, adds/removes error classes */
             const validateInput = (inputElement) => {
                const value = inputElement.value.trim();
                const errorElement = trackingForm.querySelector(`.form-error[data-for="${inputElement.id}"]`) ||
                                     goalsForm.querySelector(`.form-error[data-for="${inputElement.id}"]`) ||
                                     entryDetailModal.querySelector(`.form-error[data-for="${inputElement.id}"]`) ||
                                     reportGenerationForm.querySelector(`.form-error[data-for="${inputElement.id}"]`);

                 let isValid = true;
                 inputElement.parentElement.classList.remove('error');
                 if (errorElement) errorElement.style.display = 'none';

                 // Basic check for empty required fields (add required attribute in HTML)
                 if (inputElement.required && value === '') {
                     isValid = false;
                 }
                 // Specific checks for number inputs
                 else if (inputElement.type === 'number') {
                    const numberValue = parseFloat(value);
                    const min = inputElement.min ? parseFloat(inputElement.min) : null;
                    const max = inputElement.max ? parseFloat(inputElement.max) : null;

                    if (value === '') { // Allow empty number fields unless required
                        isValid = !inputElement.required;
                    } else if (isNaN(numberValue)) {
                        isValid = false;
                    } else {
                        if (min !== null && numberValue < min) isValid = false;
                        if (max !== null && numberValue > max) isValid = false;
                    }
                 }
                 // Specific check for date inputs
                 else if (inputElement.type === 'date' && inputElement.required) {
                     // Basic check, more complex validation (e.g., range) could be added
                     try {
                         new Date(value).toISOString(); // Check if it's a valid date format
                     } catch (e) {
                         isValid = false;
                     }
                 }


                 if (!isValid) {
                    inputElement.parentElement.classList.add('error');
                    if (errorElement) errorElement.style.display = 'block';
                 }
                 return isValid;
             };

            /** Debounce function */
            const debounce = (func, delay) => {
                let timeoutId;
                return function(...args) {
                    clearTimeout(timeoutId);
                    timeoutId = setTimeout(() => {
                        func.apply(this, args);
                    }, delay);
                };
            };

             /** Get current theme based on settings and system preference */
             const getCurrentTheme = () => {
                 if (appData.userSettings.theme === 'system') {
                     return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
                 }
                 return appData.userSettings.theme;
             };

             /** Check if goals were met for a given record */
             const goalsMetForDay = (record, goals) => {
                 if (!record) return false;
                 const stepsMet = record.totalSteps >= goals.steps;
                 // Sleep goal met if recorded and >= goal. If not recorded (null), doesn't count against meeting goals.
                 const sleepMet = record.sleepDuration === null || record.sleepDuration >= goals.sleep;
                 // Calorie goal met if recorded and <= goal. If not recorded (0), doesn't count against meeting goals.
                 const caloriesMet = record.totalCalories === 0 || (record.totalCalories > 0 && record.totalCalories <= goals.calories);
                  // Only count days where at least *some* data was logged
                 const dataLogged = record.totalSteps > 0 || record.sleepDuration !== null || record.totalCalories > 0;

                 return dataLogged && stepsMet && sleepMet && caloriesMet;
             };

            /** Helper for achievement checks: Find if condition met for N consecutive days ending today/yesterday */
            const checkConsecutiveDays = (recordsObj, conditionFn, count) => {
                 let consecutive = 0;
                 const today = new Date();
                 for (let i = 0; i < count; i++) {
                     const dateToCheck = new Date(today);
                     dateToCheck.setDate(today.getDate() - i);
                     const dateStr = formatDate(dateToCheck);
                     const record = recordsObj[dateStr];
                     if (record && conditionFn(record)) {
                         consecutive++;
                     } else {
                         break; // Streak broken
                     }
                 }
                 return consecutive >= count;
             };


            // ===== Data Persistence =====
            const saveData = () => {
                try {
                    localStorage.setItem(APP_STORAGE_KEY, JSON.stringify(appData));
                    // console.log("Data saved:", appData); // For debugging
                } catch (error) {
                    console.error("Error saving data to localStorage:", error);
                    showToast("Error saving data. Changes might not persist.", 'danger');
                }
            };

            const loadData = () => {
                 try {
                     const storedData = localStorage.getItem(APP_STORAGE_KEY);
                     if (storedData) {
                         const parsedData = JSON.parse(storedData);
                         // Simple merge, could be more sophisticated if structure changes drastically
                         appData = { ...appData, ...parsedData };
                         // Ensure nested objects exist
                         appData.userSettings = appData.userSettings || { theme: 'system', sidebarCollapsed: false, lastVisitedSection: 'overview' };
                         appData.goals = appData.goals || { steps: 10000, sleep: 8, calories: 2000 };
                         appData.goalsHistory = appData.goalsHistory || [];
                         appData.dailyRecords = appData.dailyRecords || {};
                         appData.achievements = appData.achievements || [];
                         appData.streaks = appData.streaks || { current: 0, best: 0, lastDate: null };
                         console.log("Data loaded:", appData); // For debugging
                     } else {
                         console.log("No existing data found, using defaults.");
                         // Save initial default data if nothing was loaded
                         saveData();
                     }
                 } catch (error) {
                     console.error("Error loading data from localStorage:", error);
                     showToast("Error loading saved data. Using defaults.", 'warning');
                     // In case of corrupt data, maybe reset?
                     // localStorage.removeItem(APP_STORAGE_KEY);
                 }
                 // Ensure goalsHistory has at least the initial goals if empty
                 if (appData.goalsHistory.length === 0) {
                    appData.goalsHistory.push({ date: formatDate(new Date()), goals: { ...appData.goals } });
                    saveData();
                 }
            };

             /** Get today's record, creating if it doesn't exist */
            const getTodayRecord = () => {
                const todayStr = formatDate();
                if (!appData.dailyRecords[todayStr]) {
                    appData.dailyRecords[todayStr] = {
                        date: todayStr,
                        totalSteps: 0,
                        sleepDuration: null, // Explicitly null until set
                        totalCalories: 0,
                        entries: [], // { id: timestamp, type: 'steps'/'sleep'/'calories', value: number, time: HH:MM }
                        goalsMet: false // Calculated later
                    };
                }
                return appData.dailyRecords[todayStr];
            };

             /** Get record by specific date string */
            const getRecordByDate = (dateString) => {
                return appData.dailyRecords[dateString] || null;
            };

            // ===== UI Update Functions =====

            /** Update Theme */
            const applyTheme = () => {
                const theme = getCurrentTheme();
                document.documentElement.setAttribute('data-theme', theme);
                themeToggle.innerHTML = `<i class="fas fa-${theme === 'dark' ? 'sun' : 'moon'} fa-fw"></i>`;
                // Update active button in settings
                 document.querySelectorAll('.theme-setting').forEach(btn => {
                     btn.classList.toggle('active', btn.dataset.themeValue === appData.userSettings.theme);
                 });
                 // Update chart colors (if charts exist)
                 updateChartColors();
            };

            /** Update Sidebar State */
            const applySidebarState = () => {
                const isCollapsed = appData.userSettings.sidebarCollapsed;
                 sidebar.classList.toggle('collapsed', isCollapsed);
                 // Handle mobile overlay state (controlled by 'expanded' class or body class)
                 const isMobile = window.innerWidth <= 1024;
                 if (!isMobile) {
                     sidebar.classList.remove('expanded'); // Remove mobile class on desktop
                     document.body.classList.remove('sidebar-open');
                     menuToggle.classList.add('hidden'); // Hide burger on desktop
                     sidebarToggle.style.display = 'flex'; // Show chevron toggle
                 } else {
                     menuToggle.classList.remove('hidden'); // Show burger on mobile
                     sidebarToggle.style.display = 'none'; // Hide chevron toggle
                     // Don't force collapsed on mobile load, let menu toggle control 'expanded'
                     if (!sidebar.classList.contains('expanded')) {
                        document.body.classList.remove('sidebar-open');
                     }
                 }
            };

             /** Toggle Sidebar (handles both desktop collapse and mobile expand) */
            const toggleSidebar = () => {
                const isMobile = window.innerWidth <= 1024;
                if (isMobile) {
                    const isExpanded = sidebar.classList.toggle('expanded');
                    document.body.classList.toggle('sidebar-open', isExpanded);
                    appData.userSettings.sidebarCollapsed = false; // Don't save collapsed state from mobile toggle
                } else {
                    appData.userSettings.sidebarCollapsed = !appData.userSettings.sidebarCollapsed;
                    applySidebarState();
                }
                saveData(); // Save state change only for desktop collapse
                // Trigger window resize slightly delayed to allow charts to re-render correctly
                setTimeout(() => window.dispatchEvent(new Event('resize')), 300);
            };

            /** Show Target Section */
            const showSection = (sectionId) => {
                 if (!sectionId) sectionId = 'overview'; // Default to overview
                 // Remove fragment identifier if present
                 sectionId = sectionId.startsWith('#') ? sectionId.substring(1) : sectionId;

                sections.forEach(section => {
                    section.classList.toggle('active', section.id === sectionId);
                });
                navLinks.forEach(link => {
                     link.classList.toggle('active', link.dataset.section === sectionId);
                });

                 // Special handling for button-triggered navigation
                 document.querySelectorAll('.nav-link-btn').forEach(btn => {
                     btn.classList.toggle('active', btn.dataset.section === sectionId);
                 });


                 // Update last visited section, excluding settings maybe
                 if (sectionId !== 'settings') {
                    appData.userSettings.lastVisitedSection = sectionId;
                    saveData();
                 }

                 // Scroll to top of main content
                 document.querySelector('.main-content').scrollTop = 0;

                // Update URL hash without causing page jump (optional)
                 // history.pushState(null, null, `#${sectionId}`);

                 // Trigger potential updates needed when section becomes visible
                 switch(sectionId) {
                    case 'overview':
                        updateOverviewStats();
                        renderWeeklyProgressChart();
                        renderStreakCalendar();
                        renderRecentAchievements();
                        displayHealthTip();
                        break;
                    case 'tracking':
                        updateTodayDateDisplay();
                        updateTodayEntriesTable();
                        renderTodayProgressChart();
                        break;
                    case 'history':
                        renderHistoryTable();
                        break;
                    case 'goals':
                        populateGoalsForm();
                        renderGoalsHistoryTable();
                        // renderGoalsDistributionChart(); // If using this chart
                        break;
                    case 'reports':
                        renderHealthTrendsChart();
                        renderGoalCompletionRateChart();
                        // Set default report dates
                        const todayStr = formatDate();
                        const weekAgo = new Date();
                        weekAgo.setDate(weekAgo.getDate() - 6);
                        document.getElementById('report-end-date').value = todayStr;
                        document.getElementById('report-start-date').value = formatDate(weekAgo);
                        break;
                    case 'insights':
                        generateAndDisplayInsights();
                        break;
                    case 'achievements':
                        renderAllAchievements();
                        break;
                    case 'streaks':
                        renderFullStreakCalendar();
                        updateStreakSectionDisplays();
                        break;
                     case 'settings':
                         // Update settings UI if needed
                         applyTheme(); // Ensure theme buttons are correct
                         break;
                 }
            };

            /** Update Overview Stats Display */
            const updateOverviewStats = () => {
                const todayRecord = getRecordByDate(formatDate()) || { totalSteps: 0, sleepDuration: null, totalCalories: 0 };
                 // Handle potential null sleepDuration explicitly for display
                const sleepToday = todayRecord.sleepDuration === null ? 0 : todayRecord.sleepDuration;
                const goals = appData.goals;

                // Steps
                document.getElementById('overview-steps').textContent = todayRecord.totalSteps.toLocaleString();
                document.getElementById('overview-steps-goal').textContent = goals.steps.toLocaleString();
                updateStatComparison('overview-steps-change', todayRecord.totalSteps, goals.steps);

                // Sleep
                 // Get yesterday's record for sleep display as it relates to previous night
                const yesterdayRecord = getRecordByDate(getYesterdayDate());
                const sleepValue = yesterdayRecord?.sleepDuration ?? 0; // Use 0 if no record or null
                document.getElementById('overview-sleep').textContent = `${sleepValue.toFixed(1)} hrs`;
                document.getElementById('overview-sleep-goal').textContent = `${goals.sleep.toFixed(1)} hrs`;
                 // Note: Sleep comparison logic might need adjustment (compare yesterday's sleep to goal)
                updateStatComparison('overview-sleep-change', sleepValue, goals.sleep);

                // Calories
                document.getElementById('overview-calories').textContent = todayRecord.totalCalories.toLocaleString();
                document.getElementById('overview-calories-goal').textContent = goals.calories.toLocaleString();
                 // For calories, "positive" change is exceeding goal (bad), "negative" is under (good)
                 // Let's invert the comparison logic or use neutral if close
                 updateStatComparison('overview-calories-change', todayRecord.totalCalories, goals.calories, true); // Invert = true

                // Streak
                const streakInfo = appData.streaks;
                document.getElementById('overview-streak').textContent = `${streakInfo.current} day${streakInfo.current !== 1 ? 's' : ''}`;
                document.getElementById('overview-best-streak').textContent = `${streakInfo.best} day${streakInfo.best !== 1 ? 's' : ''}`;
                const streakChangeEl = document.getElementById('overview-streak-change');
                if (streakInfo.current > 0 && streakInfo.current === streakInfo.best) {
                    streakChangeEl.innerHTML = `<i class="fas fa-star fa-fw"></i> <span>New Best!</span>`;
                    streakChangeEl.className = 'stat-change positive';
                } else if (streakInfo.current > 0) {
                     streakChangeEl.innerHTML = `<i class="fas fa-fire fa-fw"></i> <span>Active</span>`;
                     streakChangeEl.className = 'stat-change positive';
                } else {
                    streakChangeEl.innerHTML = `<span>Inactive</span>`;
                     streakChangeEl.className = 'stat-change neutral';
                }

                 // Overall Goal Completion Bar
                const completionPercent = calculateGoalCompletionPercentage(todayRecord, goals);
                const progressBar = document.getElementById('goal-completion-bar');
                const progressPercent = document.getElementById('goal-completion-percentage');
                progressBar.style.width = `${completionPercent}%`;
                progressPercent.textContent = `${Math.round(completionPercent)}%`;
                 // Change bar color based on completion
                 progressBar.className = 'progress-bar'; // Reset class
                 if (completionPercent >= 100) progressBar.classList.add('progress-bar-success');
                 else if (completionPercent >= 66) progressBar.classList.add('progress-bar-primary'); // Use primary color
                 else if (completionPercent >= 33) progressBar.classList.add('progress-bar-warning');
                 else progressBar.classList.add('progress-bar-danger');


            };

            /** Helper for updating stat comparison element */
            const updateStatComparison = (elementId, currentValue, goalValue, invert = false) => {
                 const element = document.getElementById(elementId);
                 const valueSpan = element.querySelector('span');
                 const icon = element.querySelector('i');
                 if (!element || !valueSpan || !icon) return;

                 if (goalValue <= 0) { // Avoid division by zero or meaningless comparison
                     element.className = 'stat-change neutral';
                     icon.className = 'fas fa-minus fa-fw';
                     valueSpan.textContent = '--%';
                     return;
                 }

                 const percentageDiff = ((currentValue - goalValue) / goalValue) * 100;
                 let comparisonClass = 'neutral';
                 let iconClass = 'fa-minus';

                 if (Math.abs(percentageDiff) < 2) { // Consider close values neutral
                     comparisonClass = 'neutral';
                     iconClass = 'fa-equals'; // Use equals icon
                 } else if (currentValue > goalValue) {
                     comparisonClass = invert ? 'negative' : 'positive'; // e.g., Exceeding calorie goal is negative
                     iconClass = 'fa-arrow-up';
                 } else if (currentValue < goalValue) {
                     comparisonClass = invert ? 'positive' : 'negative'; // e.g., Under calorie goal is positive
                     iconClass = 'fa-arrow-down';
                 }

                 element.className = `stat-change ${comparisonClass}`;
                 icon.className = `fas ${iconClass} fa-fw`;
                  // Show "+" sign for positive differences
                 valueSpan.textContent = `${percentageDiff >= 0 ? '+' : ''}${Math.round(percentageDiff)}%`;
            };

             /** Calculate overall goal completion percentage for the day */
            const calculateGoalCompletionPercentage = (record, goals) => {
                if (!record) return 0;
                 let totalPossible = 0;
                 let totalAchieved = 0;

                 // Steps
                 if (goals.steps > 0) {
                    totalPossible += 1;
                    totalAchieved += Math.min(1, record.totalSteps / goals.steps);
                 }

                 // Sleep (Count if goal > 0 and sleep was logged)
                 if (goals.sleep > 0 && record.sleepDuration !== null) {
                     totalPossible += 1;
                     // Cap achievement at 100% of goal, don't penalize oversleeping much? Or cap at 1?
                     totalAchieved += Math.min(1, record.sleepDuration / goals.sleep);
                 } else if (goals.sleep > 0 && record.sleepDuration === null) {
                     // If sleep has a goal but wasn't logged, count it as possible but not achieved
                     totalPossible += 1;
                     totalAchieved += 0;
                 }

                 // Calories (More complex: closer to 0 is better up to the goal)
                 if (goals.calories > 0 && record.totalCalories > 0) {
                     totalPossible += 1;
                     // 1 if under goal, decreases linearly to 0 if double the goal, 0 if more than double
                     const overageRatio = (record.totalCalories - goals.calories) / goals.calories;
                     totalAchieved += Math.max(0, 1 - overageRatio);
                 } else if (goals.calories > 0 && record.totalCalories === 0) {
                      // If calories have a goal but none logged, count as possible but not achieved
                      totalPossible += 1;
                      totalAchieved += 0;
                 }

                 if (totalPossible === 0) return 0; // Avoid division by zero
                 return (totalAchieved / totalPossible) * 100;
            };


             /** Display a relevant health tip */
            const displayHealthTip = () => {
                const todayRecord = getRecordByDate(formatDate()) || {};
                const goals = appData.goals;
                const streaks = appData.streaks;
                const tipContainer = document.getElementById('health-tip-container');

                 let chosenTip = null;

                 for (const tipDef of healthTips) {
                     if (tipDef.condition(todayRecord, goals, streaks)) {
                         chosenTip = tipDef.getTip(todayRecord, goals, streaks);
                         break; // Use the first matching tip
                     }
                 }

                 if (chosenTip) {
                     tipContainer.innerHTML = `
                         <div class="alert alert-${chosenTip.type || 'primary'}">
                             <div class="alert-icon"><i class="fas fa-${chosenTip.type === 'danger' ? 'exclamation-triangle' : (chosenTip.type === 'warning' ? 'exclamation-circle' : (chosenTip.type === 'success' ? 'check-circle' : 'info-circle'))} fa-fw"></i></div>
                             <div class="alert-content">
                                 <div class="alert-title">${chosenTip.title || 'Health Tip'}</div>
                                 <p class="alert-message">${chosenTip.text}</p>
                             </div>
                         </div>`;
                 } else {
                      // Should always have the default tip, but just in case
                      tipContainer.innerHTML = `<div class="alert alert-secondary">No tips available right now.</div>`;
                 }
            };

             /** Render recent activity streak calendar (small version) */
             const renderStreakCalendar = () => {
                const calendarEl = document.getElementById('streak-calendar');
                const today = new Date();
                calendarEl.innerHTML = ''; // Clear previous

                // Display last 7 days (including today)
                 const daysToShow = 7;
                 let dayOfWeek = today.getDay(); // 0=Sun, 6=Sat
                 // Adjust to start from Monday or Sunday depending on preference? Assume Sunday start for now.
                 // We need to show days BEFORE today to fill the week row.

                 // Calculate the start date (Sunday of the current week)
                 const startDate = new Date(today);
                 startDate.setDate(today.getDate() - dayOfWeek);

                 for (let i = 0; i < daysToShow; i++) {
                    const currentDay = new Date(startDate);
                    currentDay.setDate(startDate.getDate() + i);
                    const dateStr = formatDate(currentDay);
                    const record = getRecordByDate(dateStr);
                    const isToday = dateStr === formatDate(today);
                    const isFuture = currentDay > today;

                    const dayEl = document.createElement('div');
                    dayEl.classList.add('streak-day');
                    dayEl.textContent = currentDay.getDate(); // Show day number

                    if (isToday) dayEl.classList.add('today');
                    if (isFuture) {
                        dayEl.classList.add('future');
                    } else if (record) {
                         const metGoals = goalsMetForDay(record, appData.goals);
                         if (metGoals) {
                             dayEl.classList.add('active'); // Use success color
                             dayEl.dataset.tooltip = `${formatReadableDate(currentDay)}: Goals Met!`;
                         } else if (record.entries.length > 0 || record.totalSteps > 0 || record.sleepDuration !== null || record.totalCalories > 0) {
                             dayEl.classList.add('partial'); // Use warning color
                              dayEl.dataset.tooltip = `${formatReadableDate(currentDay)}: Activity Logged`;
                         } else {
                              // Day has a record object but no actual data logged? Grey.
                               dayEl.dataset.tooltip = formatReadableDate(currentDay);
                         }
                    } else {
                         // Past day with no record
                         dayEl.dataset.tooltip = formatReadableDate(currentDay);
                    }

                    calendarEl.appendChild(dayEl);
                 }
                 // Update streak display below calendar
                 document.getElementById('current-streak-display').textContent = `${appData.streaks.current} day${appData.streaks.current !== 1 ? 's' : ''}`;
             };

            /** Render recent achievements (e.g., top 3) */
            const renderRecentAchievements = () => {
                const container = document.getElementById('recent-achievements');
                const emptyMessage = document.getElementById('recent-achievements-empty');
                container.innerHTML = ''; // Clear previous

                 // Sort earned achievements by date, newest first
                 const earnedAchievements = appData.achievements
                    .map(ach => ({ ...ach, definition: achievementDefinitions.find(def => def.id === ach.id) }))
                    .filter(ach => ach.definition) // Ensure definition exists
                    .sort((a, b) => new Date(b.dateEarned) - new Date(a.dateEarned));

                 const recent = earnedAchievements.slice(0, 3); // Get top 3

                 if (recent.length > 0) {
                    emptyMessage.classList.add('hidden');
                    recent.forEach(ach => {
                        const el = createAchievementElement(ach.definition, ach.dateEarned);
                         // Add animation classes if desired
                        container.appendChild(el);
                    });
                 } else {
                    emptyMessage.classList.remove('hidden');
                 }
            };

            /** Update today's date display */
            const updateTodayDateDisplay = () => {
                if (todayDateSpan) {
                    todayDateSpan.textContent = formatReadableDate(new Date());
                }
            };

            /** Render table of today's logged entries */
            const updateTodayEntriesTable = () => {
                const tbody = document.getElementById('today-entries-tbody');
                const placeholder = tbody.querySelector('.placeholder');
                tbody.innerHTML = ''; // Clear previous entries (keep placeholder structure)
                tbody.appendChild(placeholder); // Re-add placeholder


                const todayRecord = getTodayRecord(); // Gets or creates today's record

                 if (todayRecord.entries.length === 0) {
                     placeholder.classList.remove('hidden');
                     return;
                 }

                placeholder.classList.add('hidden');

                // Sort entries by time (newest first)
                todayRecord.entries.sort((a, b) => b.id - a.id);

                todayRecord.entries.forEach(entry => {
                    const tr = document.createElement('tr');
                    tr.dataset.entryId = entry.id; // Store ID for editing/deleting

                    let typeDisplay = '';
                    let valueDisplay = '';
                    let iconClass = '';

                    switch (entry.type) {
                        case 'steps':
                            typeDisplay = 'Steps Added';
                            valueDisplay = `${entry.value.toLocaleString()}`;
                            iconClass = 'fa-walking';
                            break;
                         case 'sleep':
                            typeDisplay = 'Sleep Recorded';
                            valueDisplay = `${entry.value.toFixed(1)} hrs`;
                             iconClass = 'fa-bed';
                             // For sleep, we might want to show the date it applies to (yesterday)
                            // typeDisplay += ` (for ${formatReadableDate(getYesterdayDate())})`;
                            break;
                        case 'calories':
                            typeDisplay = 'Calories Added';
                            valueDisplay = `${entry.value.toLocaleString()} kcal`;
                            iconClass = 'fa-utensils';
                            break;
                         default:
                            typeDisplay = 'Unknown Entry';
                            valueDisplay = entry.value;
                            iconClass = 'fa-question-circle';
                    }

                    tr.innerHTML = `
                        <td>${entry.time}</td>
                        <td><i class="fas ${iconClass} fa-fw text-muted"></i> ${typeDisplay}</td>
                        <td>${valueDisplay}</td>
                        <td>
                            <button class="btn btn-icon-sm btn-ghost edit-entry-btn" data-tooltip="Edit">
                                <i class="fas fa-pencil-alt fa-fw"></i>
                            </button>
                            <button class="btn btn-icon-sm btn-ghost delete-entry-btn" data-tooltip="Delete">
                                <i class="fas fa-trash-alt fa-fw"></i>
                            </button>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            };

             /** Populate the goals form with current values */
            const populateGoalsForm = () => {
                document.getElementById('steps-goal').value = appData.goals.steps;
                document.getElementById('sleep-goal').value = appData.goals.sleep;
                document.getElementById('calories-goal').value = appData.goals.calories;
            };

            /** Render the table showing goal change history */
            const renderGoalsHistoryTable = () => {
                 const tbody = document.getElementById('goals-history-tbody');
                 const placeholder = tbody.querySelector('.placeholder');
                 tbody.innerHTML = '';
                 tbody.appendChild(placeholder); // Re-add placeholder

                 if (appData.goalsHistory.length <= 1) { // Only show history if changes exist (more than initial)
                     placeholder.classList.remove('hidden');
                     return;
                 }

                placeholder.classList.add('hidden');

                // Sort history, newest first (skip the initial entry if desired, or show all)
                 // Let's show all, newest first
                 [...appData.goalsHistory].reverse().forEach(entry => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${formatReadableDate(entry.date)}</td>
                        <td>${entry.goals.steps.toLocaleString()}</td>
                        <td>${entry.goals.sleep.toFixed(1)}</td>
                        <td>${entry.goals.calories.toLocaleString()}</td>
                    `;
                    tbody.appendChild(tr);
                 });
            };

            /** Render the main history table */
             const renderHistoryTable = (filter = '') => {
                 const tbody = document.getElementById('history-tbody');
                 const placeholder = tbody.querySelector('.placeholder');
                 tbody.innerHTML = '';
                 tbody.appendChild(placeholder); // Re-add placeholder

                 const records = Object.values(appData.dailyRecords)
                     .filter(record => record.date.includes(filter)) // Apply date filter
                     .sort((a, b) => b.date.localeCompare(a.date)); // Sort newest first

                 if (records.length === 0) {
                     placeholder.classList.remove('hidden');
                     placeholder.querySelector('p').textContent = filter ? `No records found for "${filter}"` : 'No past records found';
                     return;
                 }

                 placeholder.classList.add('hidden');

                 records.forEach(record => {
                     const tr = document.createElement('tr');
                     const goalsMet = goalsMetForDay(record, appData.goals); // Check goals for that day
                     const goalStatus = goalsMet
                        ? '<span class="badge badge-success"><i class="fas fa-check fa-fw"></i> Met</span>'
                        : '<span class="badge badge-outline-warning"><i class="fas fa-times fa-fw"></i> Not Met</span>';
                     const sleepDisplay = record.sleepDuration === null ? '--' : record.sleepDuration.toFixed(1);

                     tr.innerHTML = `
                        <td>${formatReadableDate(record.date)}</td>
                        <td>${record.totalSteps.toLocaleString()}</td>
                        <td>${sleepDisplay}</td>
                        <td>${record.totalCalories.toLocaleString()}</td>
                        <td>${goalStatus}</td>
                        <!--<td>-->
                           <!-- Add View button if implementing detail view -->
                           <!-- <button class="btn btn-sm btn-ghost view-history-details" data-date="${record.date}">View</button> -->
                        <!--</td>-->
                    `;
                     tbody.appendChild(tr);
                 });
             };

             /** Update streak displays in the Streaks section */
             const updateStreakSectionDisplays = () => {
                 document.getElementById('streaks-current-display').textContent = appData.streaks.current;
                 document.getElementById('streaks-best-display').textContent = appData.streaks.best;
             };

            /** Render the full streak calendar (e.g., for a year or month) */
             const renderFullStreakCalendar = (year = new Date().getFullYear()) => {
                 // TODO: Implement logic to display a larger calendar, possibly year view
                 // This is more complex, involving calculating weeks, leap years etc.
                 // For now, let's render the current month as an example.
                 const container = document.getElementById('full-streak-calendar');
                 container.innerHTML = ''; // Clear

                 const today = new Date();
                 const currentMonth = today.getMonth();
                 const currentYear = year; // Use provided year

                 const date = new Date(currentYear, currentMonth, 1);
                 const monthName = date.toLocaleDateString(undefined, { month: 'long', year: 'numeric' });

                 const header = document.createElement('h4');
                 header.textContent = monthName;
                 header.style.textAlign = 'center';
                 header.style.marginBottom = '1rem';
                 container.appendChild(header);

                 const calendarGrid = document.createElement('div');
                 calendarGrid.classList.add('streak-calendar'); // Use existing class for styling

                 // Add day headers (Mon, Tue, etc.)
                 const daysOfWeek = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
                 daysOfWeek.forEach(day => {
                     const dayHeader = document.createElement('div');
                     dayHeader.classList.add('streak-day-header', 'text-muted'); // Add a class for styling headers
                     dayHeader.style.textAlign = 'center';
                     dayHeader.style.fontWeight = 'var(--font-weight-medium)';
                     dayHeader.style.fontSize = '0.75rem';
                     dayHeader.textContent = day;
                     calendarGrid.appendChild(dayHeader);
                 });


                 // Add empty cells for days before the 1st of the month
                 const firstDayOfMonth = date.getDay(); // 0 = Sunday
                 for (let i = 0; i < firstDayOfMonth; i++) {
                     const emptyCell = document.createElement('div');
                     calendarGrid.appendChild(emptyCell);
                 }

                 // Add days of the month
                 while (date.getMonth() === currentMonth) {
                    const dayOfMonth = date.getDate();
                    const dateStr = formatDate(date);
                    const record = getRecordByDate(dateStr);
                    const isToday = dateStr === formatDate(today);
                    const isFuture = date > today;

                    const dayEl = document.createElement('div');
                    dayEl.classList.add('streak-day');
                    dayEl.textContent = dayOfMonth;

                    if (isToday) dayEl.classList.add('today');
                     if (isFuture) {
                        // Future day - keep default style or make it slightly different
                        dayEl.classList.add('future'); // Add future class if styled
                     } else if (record) {
                         const metGoals = goalsMetForDay(record, appData.goals);
                         if (metGoals) {
                             dayEl.classList.add('active');
                             dayEl.dataset.tooltip = `${formatReadableDate(date)}: Goals Met!`;
                         } else if (record.entries.length > 0 || record.totalSteps > 0 || record.sleepDuration !== null || record.totalCalories > 0) {
                             dayEl.classList.add('partial');
                             dayEl.dataset.tooltip = `${formatReadableDate(date)}: Activity Logged`;
                         } else {
                             dayEl.dataset.tooltip = formatReadableDate(date);
                         }
                     } else {
                        // Past day, no record
                         dayEl.dataset.tooltip = formatReadableDate(date);
                     }

                    calendarGrid.appendChild(dayEl);
                    date.setDate(dayOfMonth + 1); // Move to the next day
                 }
                  container.appendChild(calendarGrid);
             };


            /** Render all achievements */
            const renderAllAchievements = () => {
                const container = document.getElementById('all-achievements');
                container.innerHTML = ''; // Clear

                 let earnedCount = 0;
                 achievementDefinitions.forEach(def => {
                     const earned = appData.achievements.find(a => a.id === def.id);
                     const el = createAchievementElement(def, earned ? earned.dateEarned : null);
                     container.appendChild(el);
                     if (earned) earnedCount++;
                 });

                 // Update count badge
                 document.getElementById('achievements-count').textContent = `${earnedCount} / ${achievementDefinitions.length}`;
            };

             /** Helper to create a single achievement element */
             const createAchievementElement = (definition, dateEarned) => {
                const achievementEl = document.createElement('div');
                achievementEl.classList.add('achievement');
                achievementEl.classList.toggle('locked', !dateEarned);
                achievementEl.dataset.tooltip = dateEarned
                    ? `${definition.description} (Earned: ${formatReadableDate(dateEarned)})`
                    : definition.description; // Set tooltip based on state


                achievementEl.innerHTML = `
                    <div class="achievement-icon">
                        <i class="fas fa-${definition.icon || 'question-circle'} fa-fw"></i>
                    </div>
                    <div class="achievement-title">${definition.title}</div>
                    ${!dateEarned ? '<div class="achievement-description">Locked</div>' : ''}
                 `;
                // ${dateEarned ? `<div class="achievement-description">Earned: ${formatReadableDate(dateEarned)}</div>` : '<div class="achievement-description">Locked</div>'}

                return achievementEl;
            };

             /** Generate and display insights */
             const generateAndDisplayInsights = () => {
                const container = document.getElementById('insights-container');
                const loadingEl = document.getElementById('insights-loading');
                const emptyEl = document.getElementById('insights-empty');
                container.innerHTML = ''; // Clear previous insights
                container.appendChild(loadingEl); // Show loading
                container.appendChild(emptyEl);
                 loadingEl.classList.remove('hidden');
                 emptyEl.classList.add('hidden');

                 // Simulate loading/analysis delay
                 setTimeout(() => {
                     const insights = [];
                     const records = Object.values(appData.dailyRecords).sort((a,b) => a.date.localeCompare(b.date));
                     const goals = appData.goals;

                     if (records.length < 7) { // Need at least a week of data
                          loadingEl.classList.add('hidden');
                          emptyEl.classList.remove('hidden');
                          return;
                     }

                     // --- Insight Examples ---

                     // 1. Step Consistency
                     const stepAvg = records.reduce((sum, r) => sum + r.totalSteps, 0) / records.length;
                     const stepGoalMetRate = records.filter(r => r.totalSteps >= goals.steps).length / records.length * 100;
                     if (stepGoalMetRate > 70) {
                         insights.push({ type: 'success', title: 'Great Step Consistency!', text: `You meet your step goal ${stepGoalMetRate.toFixed(0)}% of the time. Keep moving!` });
                     } else if (stepGoalMetRate < 30 && records.length > 14) {
                         insights.push({ type: 'warning', title: 'Step Goal Challenge', text: `You're meeting your step goal less than 30% of the time. Consider adjusting the goal or adding short walks to your routine.` });
                     } else {
                         insights.push({ type: 'info', title: 'Step Analysis', text: `Your average daily steps are ${stepAvg.toFixed(0)}. You meet your goal ${stepGoalMetRate.toFixed(0)}% of the time.` });
                     }

                     // 2. Sleep Patterns
                     const sleepRecords = records.filter(r => r.sleepDuration !== null);
                     if (sleepRecords.length > 5) {
                         const sleepAvg = sleepRecords.reduce((sum, r) => sum + r.sleepDuration, 0) / sleepRecords.length;
                         const sleepGoalMetRate = sleepRecords.filter(r => r.sleepDuration >= goals.sleep).length / sleepRecords.length * 100;
                         if (sleepAvg < goals.sleep * 0.85) {
                             insights.push({ type: 'warning', title: 'Optimize Your Sleep', text: `Your average sleep (${sleepAvg.toFixed(1)} hrs) is below your goal (${goals.sleep} hrs). Prioritizing consistent bedtimes might help.` });
                         } else {
                             insights.push({ type: 'info', title: 'Sleep Habits', text: `Average sleep duration: ${sleepAvg.toFixed(1)} hrs. You meet your sleep goal ${sleepGoalMetRate.toFixed(0)}% of the time.` });
                         }
                     }

                     // 3. Weekend vs Weekday Steps (Example)
                     const weekdaySteps = records.filter(r => ![0, 6].includes(new Date(r.date + 'T00:00:00').getDay())); // Mon-Fri
                     const weekendSteps = records.filter(r => [0, 6].includes(new Date(r.date + 'T00:00:00').getDay())); // Sat-Sun
                     if (weekdaySteps.length > 5 && weekendSteps.length > 2) {
                         const avgWeekday = weekdaySteps.reduce((s, r) => s + r.totalSteps, 0) / weekdaySteps.length;
                         const avgWeekend = weekendSteps.reduce((s, r) => s + r.totalSteps, 0) / weekendSteps.length;
                         if (avgWeekend > avgWeekday * 1.2) {
                             insights.push({ type: 'info', title: 'Weekend Warrior', text: `You tend to be significantly more active on weekends (Avg: ${avgWeekend.toFixed(0)} steps) compared to weekdays (Avg: ${avgWeekday.toFixed(0)} steps).` });
                         } else if (avgWeekday > avgWeekend * 1.2) {
                              insights.push({ type: 'info', title: 'Weekday Mover', text: `You're generally more active during the week (Avg: ${avgWeekday.toFixed(0)} steps) than on weekends (Avg: ${avgWeekend.toFixed(0)} steps).` });
                         }
                     }

                      // 4. Calorie Goal Adherence
                      const calorieRecords = records.filter(r => r.totalCalories > 0);
                       if (calorieRecords.length > 5) {
                           const calorieGoalMetRate = calorieRecords.filter(r => r.totalCalories <= goals.calories).length / calorieRecords.length * 100;
                           const avgCalories = calorieRecords.reduce((sum, r) => sum + r.totalCalories, 0) / calorieRecords.length;
                           if (calorieGoalMetRate < 50) {
                               insights.push({ type: 'warning', title: 'Calorie Goal Focus', text: `You stay within your calorie goal about ${calorieGoalMetRate.toFixed(0)}% of the time. Reviewing portion sizes or food choices could be beneficial.` });
                           } else {
                               insights.push({ type: 'info', title: 'Nutrition Tracking', text: `Average daily intake: ${avgCalories.toFixed(0)} kcal. You meet your calorie goal ${calorieGoalMetRate.toFixed(0)}% of the time.` });
                           }
                       }


                     // --- Display Insights ---
                     loadingEl.classList.add('hidden');
                     if (insights.length > 0) {
                         emptyEl.classList.add('hidden');
                         insights.forEach(insight => {
                             const insightEl = document.createElement('div');
                             insightEl.classList.add('alert', `alert-${insight.type || 'info'}`, 'animate-fade-in');
                              insightEl.innerHTML = `
                                 <div class="alert-icon"><i class="fas fa-${insight.type === 'danger' ? 'exclamation-triangle' : (insight.type === 'warning' ? 'exclamation-circle' : (insight.type === 'success' ? 'check-circle' : 'lightbulb'))} fa-fw"></i></div>
                                 <div class="alert-content">
                                     ${insight.title ? `<div class="alert-title">${insight.title}</div>` : ''}
                                     <p class="alert-message">${insight.text}</p>
                                 </div>`;
                             container.appendChild(insightEl);
                         });
                     } else {
                         emptyEl.classList.remove('hidden');
                     }

                 }, 500); // Simulate delay
             };

            // ===== Toast Notifications =====
            const showToast = (message, type = 'info', duration = 4000) => {
                const toast = document.createElement('div');
                toast.className = `toast toast-${type}`;
                const iconClass = type === 'success' ? 'fa-check-circle' :
                                  type === 'warning' ? 'fa-exclamation-circle' :
                                  type === 'danger' ? 'fa-exclamation-triangle' :
                                  'fa-info-circle';

                toast.innerHTML = `
                    <div class="toast-icon"><i class="fas ${iconClass} fa-fw"></i></div>
                    <div class="toast-content">
                        <!-- <div class="toast-title">Notification</div> -->
                        <p class="toast-message">${message}</p>
                    </div>
                    <button class="toast-close"><i class="fas fa-times fa-fw"></i></button>
                `;

                toastContainer.appendChild(toast);

                // Trigger show animation
                requestAnimationFrame(() => {
                    toast.classList.add('show');
                });

                const closeButton = toast.querySelector('.toast-close');
                let hideTimeout;

                const hideToast = () => {
                    clearTimeout(hideTimeout);
                    toast.classList.remove('show');
                    toast.classList.add('hide'); // Add hide class for animation
                     // Remove element after animation
                     toast.addEventListener('transitionend', () => {
                         if (toast.parentElement === toastContainer) { // Check if still child
                             toastContainer.removeChild(toast);
                         }
                     }, { once: true }); // Use { once: true } for cleanup
                };

                closeButton.addEventListener('click', hideToast);

                // Auto hide after duration
                hideTimeout = setTimeout(hideToast, duration);
            };


            // ===== Modal Handling =====
            const showModal = (modalId, contentCallback = null) => {
                 const modalBackdrop = document.getElementById(modalId);
                 if (!modalBackdrop) return;

                 if (contentCallback) {
                     contentCallback(); // Populate content before showing
                 }

                 modalBackdrop.classList.remove('hidden');
                 // Trigger reflow before adding 'show' for transition
                 modalBackdrop.offsetWidth;
                 modalBackdrop.classList.add('show');
                 // Add class to body? e.g., document.body.classList.add('modal-open');
            };

            const hideModal = (modalId) => {
                const modalBackdrop = document.getElementById(modalId);
                 if (!modalBackdrop) return;

                modalBackdrop.classList.remove('show');
                 // Remove after transition ends
                 modalBackdrop.addEventListener('transitionend', () => {
                      if (!modalBackdrop.classList.contains('show')) { // Check if still hidden
                          modalBackdrop.classList.add('hidden');
                      }
                 }, { once: true });
                  // document.body.classList.remove('modal-open');
            };

             // Generic modal close listener
            document.addEventListener('click', (event) => {
                // Close modal if backdrop or close button is clicked
                if (event.target.matches('.modal-backdrop') || event.target.closest('[data-dismiss="modal"]')) {
                     const openModal = document.querySelector('.modal-backdrop.show');
                     if (openModal) {
                         hideModal(openModal.id);
                     }
                }
             });
             // Close modal on Escape key
             document.addEventListener('keydown', (event) => {
                 if (event.key === 'Escape') {
                     const openModal = document.querySelector('.modal-backdrop.show');
                     if (openModal) {
                         hideModal(openModal.id);
                     }
                 }
             });

            // ===== Confirmation Modal =====
             let confirmCallback = null;
             const showConfirmationModal = (title, message, onConfirm) => {
                 document.getElementById('confirmation-title').textContent = title;
                 document.getElementById('confirmation-message').textContent = message;
                 confirmCallback = onConfirm;
                 showModal('confirmation-modal');
             };
             document.getElementById('confirm-action-button').addEventListener('click', () => {
                 if (typeof confirmCallback === 'function') {
                     confirmCallback();
                 }
                 hideModal('confirmation-modal');
                 confirmCallback = null; // Reset callback
             });


            // ===== Core Logic Functions =====

            /** Add health entries, update totals, check achievements/streaks */
            const addHealthEntry = (type, value) => {
                 if (isNaN(value) || value < 0) {
                     console.warn(`Invalid value for ${type}: ${value}`);
                     return false; // Indicate failure
                 }

                 const todayRecord = getTodayRecord();
                 const entryId = Date.now(); // Use timestamp as unique ID
                 const currentTime = formatTime();

                 const newEntry = { id: entryId, type, value, time: currentTime };
                 todayRecord.entries.push(newEntry);

                 // Update totals
                 switch (type) {
                    case 'steps':
                        todayRecord.totalSteps += value;
                        break;
                    case 'sleep':
                         // Sleep duration OVERWRITES the value for the day (represents total)
                         // But we log the entry that set it.
                         todayRecord.sleepDuration = value;
                         // Associate sleep with previous night technically, but log entry for today
                        break;
                    case 'calories':
                        todayRecord.totalCalories += value;
                        break;
                 }

                 console.log(`Added entry: ${type}=${value}`);
                 return true; // Indicate success
            };

            /** Process form submission for tracking */
            const handleTrackingFormSubmit = (event) => {
                 event.preventDefault();
                 const stepsInput = document.getElementById('steps');
                 const sleepInput = document.getElementById('sleep');
                 const caloriesInput = document.getElementById('calories');

                 // Basic validation (allow empty inputs)
                 const stepsValue = stepsInput.value ? parseFloat(stepsInput.value) : null;
                 const sleepValue = sleepInput.value ? parseFloat(sleepInput.value) : null;
                 const caloriesValue = caloriesInput.value ? parseFloat(caloriesInput.value) : null;

                 let addedSomething = false;
                 let validationOk = true;

                 // Validate and add entries
                 if (stepsValue !== null) {
                     if (validateInput(stepsInput)) {
                         if (addHealthEntry('steps', stepsValue)) addedSomething = true;
                     } else validationOk = false;
                 }
                 if (sleepValue !== null) {
                      if (validateInput(sleepInput)) {
                         if (addHealthEntry('sleep', sleepValue)) addedSomething = true;
                     } else validationOk = false;
                 }
                 if (caloriesValue !== null) {
                      if (validateInput(caloriesInput)) {
                         if (addHealthEntry('calories', caloriesValue)) addedSomething = true;
                     } else validationOk = false;
                 }

                 if (!validationOk) {
                    showToast('Please correct the errors in the form.', 'danger');
                    return; // Stop if validation failed
                 }

                 if (addedSomething) {
                    // Update UI elements
                    updateTodayEntriesTable();
                    updateOverviewStats(); // Update overview cards
                    renderTodayProgressChart(); // Update today's chart
                    updateStreaksAndGoalsMet(); // Update streak/goal status
                    checkAndGrantAchievements(); // Check achievements
                    displayHealthTip(); // Update tip based on new data
                    renderStreakCalendar(); // Update overview calendar


                    // Clear form
                    stepsInput.value = '';
                    sleepInput.value = '';
                    caloriesInput.value = '';
                     // Remove any lingering error states
                    stepsInput.parentElement.classList.remove('error');
                    sleepInput.parentElement.classList.remove('error');
                    caloriesInput.parentElement.classList.remove('error');
                    trackingForm.querySelectorAll('.form-error').forEach(el => el.style.display = 'none');


                    saveData();
                    showToast('Health data added successfully!', 'success');
                 } else {
                     showToast('Please enter at least one value to track.', 'warning');
                 }
            };

            /** Handle goal form submission */
            const handleGoalsFormSubmit = (event) => {
                event.preventDefault();
                 const stepsGoalInput = document.getElementById('steps-goal');
                 const sleepGoalInput = document.getElementById('sleep-goal');
                 const caloriesGoalInput = document.getElementById('calories-goal');

                 let isValid = true;
                 if (!validateInput(stepsGoalInput)) isValid = false;
                 if (!validateInput(sleepGoalInput)) isValid = false;
                 if (!validateInput(caloriesGoalInput)) isValid = false;

                 if (!isValid) {
                     showToast('Please correct the errors in the goal form.', 'danger');
                     return;
                 }

                 const newGoals = {
                     steps: parseInt(stepsGoalInput.value, 10) || 0,
                     sleep: parseFloat(sleepGoalInput.value) || 0,
                     calories: parseInt(caloriesGoalInput.value, 10) || 0,
                 };

                 // Check if goals actually changed
                 if (JSON.stringify(newGoals) !== JSON.stringify(appData.goals)) {
                     appData.goals = newGoals;
                      // Add to history
                     appData.goalsHistory.push({ date: formatDate(), goals: { ...newGoals } });

                     // Update UI that depends on goals
                     updateOverviewStats();
                     renderTodayProgressChart();
                     renderGoalsHistoryTable();
                     updateAllHistoricalGoalMetStatus(); // Recalculate past goal statuses

                     saveData();
                     showToast('Goals updated successfully!', 'success');
                 } else {
                     showToast('No changes detected in goals.', 'info');
                 }
            };

             /** Recalculate goalsMet for all past records after goal change */
            const updateAllHistoricalGoalMetStatus = () => {
                 Object.keys(appData.dailyRecords).forEach(dateStr => {
                     const record = appData.dailyRecords[dateStr];
                     // Find the goals that were active on that date
                     const activeGoals = getGoalsForDate(dateStr);
                     record.goalsMet = goalsMetForDay(record, activeGoals);
                 });
                 // Also need to re-evaluate streaks based on new goal statuses
                 recalculateStreaks();
                 // Refresh relevant UI parts
                 updateOverviewStats(); // Reflects current streak
                 renderStreakCalendar();
                 if (document.getElementById('streaks').classList.contains('active')) {
                     renderFullStreakCalendar();
                     updateStreakSectionDisplays();
                 }
                 if (document.getElementById('history').classList.contains('active')) {
                     renderHistoryTable(); // Show updated goal status
                 }
            };

            /** Get the goals that were active on a specific date */
            const getGoalsForDate = (dateStr) => {
                 // Find the most recent goal entry in history that is on or before the target date
                 const targetDate = new Date(dateStr + 'T00:00:00'); // Ensure comparison is date-only
                 let activeGoals = appData.goalsHistory[0]?.goals || appData.goals; // Default to initial/current if history broken

                 for (let i = appData.goalsHistory.length - 1; i >= 0; i--) {
                     const historyEntry = appData.goalsHistory[i];
                     const historyDate = new Date(historyEntry.date + 'T00:00:00');
                     if (historyDate <= targetDate) {
                         activeGoals = historyEntry.goals;
                         break;
                     }
                 }
                 return activeGoals;
             };

            /** Update streak status and goal met status for today */
            const updateStreaksAndGoalsMet = () => {
                 const todayStr = formatDate();
                 const todayRecord = getTodayRecord(); // Ensures today's record exists
                 const goals = appData.goals; // Use current goals for today's check

                 const metToday = goalsMetForDay(todayRecord, goals);
                 todayRecord.goalsMet = metToday; // Update today's status

                 // --- Streak Logic ---
                 const streaks = appData.streaks;
                 const yesterdayStr = getYesterdayDate();

                 if (metToday) {
                     if (streaks.lastDate === yesterdayStr) {
                         // Continued streak
                         streaks.current += 1;
                     } else if (streaks.lastDate !== todayStr) {
                         // Started a new streak today (wasn't yesterday, wasn't today before this)
                         streaks.current = 1;
                     }
                     // If lastDate IS todayStr, means already processed today, do nothing more
                     streaks.lastDate = todayStr; // Mark today as the last successful day
                 } else {
                     // Goals not met today
                     if (streaks.lastDate === todayStr) {
                         // Streak was broken *today* (was previously met today, now isn't)
                         // Need to recalculate based on yesterday
                         const yesterdayRecord = getRecordByDate(yesterdayStr);
                         const goalsYesterday = getGoalsForDate(yesterdayStr);
                         if (yesterdayRecord && goalsMetForDay(yesterdayRecord, goalsYesterday)) {
                            // How many days *before* yesterday was the streak active? Requires looping back.
                            // Simple approach: if streak broke today, set current to 0.
                             streaks.current = 0;
                         } else {
                             streaks.current = 0; // Didn't meet yesterday either
                         }
                          streaks.lastDate = yesterdayStr; // Last successful was potentially yesterday
                          // This logic gets complex. A full recalculation might be safer. See recalculateStreaks.

                     } else if (streaks.lastDate !== yesterdayStr) {
                         // Streak was already broken before today (last success wasn't yesterday)
                         streaks.current = 0;
                          // lastDate remains whatever it was
                     }
                 }

                 // Update best streak
                 if (streaks.current > streaks.best) {
                     streaks.best = streaks.current;
                 }

                 console.log("Streaks updated:", streaks);
            };

            /** Recalculate streaks entirely from historical data (safer after goal changes) */
            const recalculateStreaks = () => {
                let currentStreak = 0;
                let bestStreak = 0;
                let lastMetDate = null;

                 const sortedDates = Object.keys(appData.dailyRecords).sort();

                 for (const dateStr of sortedDates) {
                     const record = appData.dailyRecords[dateStr];
                     const goalsOnDate = getGoalsForDate(dateStr); // Get goals active on that specific day
                     const metGoals = goalsMetForDay(record, goalsOnDate);

                     if (metGoals) {
                          // Check if it continues a streak from the previous day
                         const currentDate = new Date(dateStr + 'T00:00:00');
                         const previousDay = new Date(currentDate);
                         previousDay.setDate(currentDate.getDate() - 1);
                         const previousDateStr = formatDate(previousDay);

                         if (lastMetDate === previousDateStr) {
                             currentStreak++; // Continue streak
                         } else {
                             currentStreak = 1; // Start new streak
                         }
                         lastMetDate = dateStr; // Update last met date
                         bestStreak = Math.max(bestStreak, currentStreak); // Update best
                     } else {
                         // Goal not met, reset current streak for the next day check
                         currentStreak = 0;
                          // lastMetDate remains the last day goals *were* met
                     }
                 }

                 // After checking all historical data, determine the *actual* current streak
                 // The loop calculates the streak *up to* the last recorded day.
                 // We need to check if the *last recorded day* that met goals was yesterday or today.
                 const todayStr = formatDate();
                 const yesterdayStr = getYesterdayDate();

                 if (lastMetDate === todayStr) {
                     // Streak is current up to today
                     appData.streaks.current = currentStreak;
                 } else if (lastMetDate === yesterdayStr) {
                     // Streak ended yesterday
                     appData.streaks.current = currentStreak; // The loop already calculated this
                 } else {
                     // Streak ended before yesterday
                     appData.streaks.current = 0;
                 }

                 appData.streaks.best = bestStreak;
                 appData.streaks.lastDate = lastMetDate; // Store the actual last date goals were met

                 console.log("Streaks recalculated:", appData.streaks);
                 saveData(); // Save recalculated streaks
             };


            /** Check and grant achievements based on current data */
            const checkAndGrantAchievements = () => {
                 const todayRecord = getRecordByDate(formatDate()) || {};
                 const goals = appData.goals;
                 const streaks = appData.streaks;
                 const history = appData.dailyRecords; // Pass the whole history object
                 const earnedAchievementIds = appData.achievements.map(a => a.id);
                 const todayStr = formatDate();

                 achievementDefinitions.forEach(def => {
                    // Skip if already earned
                    if (earnedAchievementIds.includes(def.id)) {
                        return;
                    }

                    let conditionMet = false;
                    try {
                         // Pass relevant data to the condition function
                         conditionMet = def.condition(todayRecord, history, goals, streaks);
                    } catch (e) {
                         console.error(`Error evaluating achievement condition for '${def.id}':`, e);
                    }


                    if (conditionMet) {
                        // Grant achievement
                        const newAchievement = { id: def.id, dateEarned: todayStr };
                        appData.achievements.push(newAchievement);
                        earnedAchievementIds.push(def.id); // Update local list for this run
                        console.log(`Achievement earned: ${def.title}`);
                        showToast(` Achievement Unlocked: ${def.title}!`, 'success', 5000);
                         // Re-render achievement sections if visible
                         if (document.getElementById('overview').classList.contains('active')) renderRecentAchievements();
                         if (document.getElementById('achievements').classList.contains('active')) renderAllAchievements();
                    }
                 });
                 // No need to call saveData() here, it's called after the calling function finishes updates
            };

            /** Handle deletion of a specific entry */
            const deleteEntry = (entryId, entryDate) => {
                const record = getRecordByDate(entryDate);
                if (!record) return;

                 const entryIndex = record.entries.findIndex(e => e.id == entryId); // Use == for type coercion if needed
                 if (entryIndex === -1) return;

                 const entry = record.entries[entryIndex];

                 // Remove entry from array
                 record.entries.splice(entryIndex, 1);

                 // Adjust totals
                 switch (entry.type) {
                     case 'steps':
                         record.totalSteps = Math.max(0, record.totalSteps - entry.value);
                         break;
                     case 'sleep':
                         // If this was the *last* sleep entry for the day, reset sleepDuration
                         // This requires finding if other sleep entries exist for the same day
                         const remainingSleepEntries = record.entries.filter(e => e.type === 'sleep');
                         if (remainingSleepEntries.length > 0) {
                             // Set sleepDuration to the value of the latest remaining sleep entry
                             record.sleepDuration = remainingSleepEntries.sort((a, b) => b.id - a.id)[0].value;
                         } else {
                             record.sleepDuration = null; // No more sleep entries for this day
                         }
                         break;
                     case 'calories':
                         record.totalCalories = Math.max(0, record.totalCalories - entry.value);
                         break;
                 }

                 // Update UI
                 updateTodayEntriesTable();
                 updateOverviewStats();
                 renderTodayProgressChart();
                 updateStreaksAndGoalsMet(); // Recalculate goal/streak status
                 // Achievement removal is tricky - generally don't remove earned achievements
                 displayHealthTip();
                 renderStreakCalendar();

                 saveData();
                 showToast(`${entry.type.charAt(0).toUpperCase() + entry.type.slice(1)} entry deleted.`, 'info');
                 hideModal('entry-detail-modal'); // Close modal after deletion
            };

             /** Handle saving changes from the edit modal */
             const handleEditEntryFormSubmit = (event) => {
                event.preventDefault();
                const entryId = document.getElementById('edit-entry-id').value;
                const entryDate = document.getElementById('edit-entry-date').value;
                const valueInput = document.getElementById('edit-entry-value');

                 if (!validateInput(valueInput)) {
                    showToast('Please enter a valid value.', 'danger');
                    return;
                 }

                 const newValue = parseFloat(valueInput.value);
                 const record = getRecordByDate(entryDate);
                 if (!record) return;

                 const entryIndex = record.entries.findIndex(e => e.id == entryId);
                 if (entryIndex === -1) return;

                 const entry = record.entries[entryIndex];
                 const oldValue = entry.value;

                 // Update entry value
                 entry.value = newValue;

                  // Recalculate totals based on the change
                 switch (entry.type) {
                     case 'steps':
                         record.totalSteps = Math.max(0, record.totalSteps - oldValue + newValue);
                         break;
                     case 'sleep':
                         // Update sleep duration if this is the latest entry
                         const latestSleepEntry = record.entries
                            .filter(e => e.type === 'sleep')
                            .sort((a, b) => b.id - a.id)[0];
                         if (latestSleepEntry && latestSleepEntry.id == entryId) {
                             record.sleepDuration = newValue;
                         }
                         // If an older sleep entry is edited, it doesn't change the final sleepDuration for the day
                         break;
                     case 'calories':
                         record.totalCalories = Math.max(0, record.totalCalories - oldValue + newValue);
                         break;
                 }

                // Update UI
                 updateTodayEntriesTable();
                 updateOverviewStats();
                 renderTodayProgressChart();
                 updateStreaksAndGoalsMet();
                 checkAndGrantAchievements(); // Re-check achievements
                 displayHealthTip();
                 renderStreakCalendar();

                 saveData();
                 showToast(`${entry.type.charAt(0).toUpperCase() + entry.type.slice(1)} entry updated.`, 'success');
                 hideModal('entry-detail-modal');
             };

            /** Handle report generation request */
             const handleReportGeneration = (event) => {
                 event.preventDefault();
                 const startDateInput = document.getElementById('report-start-date');
                 const endDateInput = document.getElementById('report-end-date');
                 const reportType = document.getElementById('report-type').value;

                 let isValid = true;
                 if (!validateInput(startDateInput)) isValid = false;
                 if (!validateInput(endDateInput)) isValid = false;

                 if (!isValid) {
                     showToast('Please select valid start and end dates.', 'danger');
                     return;
                 }

                 const startDate = startDateInput.value;
                 const endDate = endDateInput.value;

                 if (startDate > endDate) {
                     showToast('Start date cannot be after end date.', 'danger');
                      startDateInput.parentElement.classList.add('error');
                      endDateInput.parentElement.classList.add('error');
                     return;
                 }

                 console.log(`Generating report: Type=${reportType}, Start=${startDate}, End=${endDate}`);
                 showToast(`Generating ${reportType} report...`, 'info');

                 // --- Filter Data ---
                 const filteredRecords = Object.values(appData.dailyRecords)
                    .filter(r => r.date >= startDate && r.date <= endDate)
                    .sort((a, b) => a.date.localeCompare(b.date)); // Oldest first for reports

                 // --- Generate Report Content (Example: CSV Export) ---
                 if (reportType === 'detailed') {
                     exportDetailedCSV(filteredRecords);
                 } else if (reportType === 'summary') {
                     exportSummaryCSV(filteredRecords);
                 } else {
                     // Placeholder for other report types (Trends, Goals) - could show a summary alert
                     showToast(`Report type "${reportType}" generation not fully implemented yet.`, 'warning');
                 }
             };

             /** Export detailed entries to CSV */
             const exportDetailedCSV = (records) => {
                if (records.length === 0) {
                     showToast('No data found for the selected period.', 'warning');
                     return;
                 }

                 let csvContent = "Date,Time,Type,Value\n"; // Header row

                 records.forEach(record => {
                     record.entries.forEach(entry => {
                         let valueDisplay = entry.value;
                         if (entry.type === 'sleep') valueDisplay = entry.value.toFixed(1); // Format sleep
                         const row = [
                             record.date,
                             entry.time,
                             entry.type,
                             valueDisplay
                         ].join(',');
                         csvContent += row + "\n";
                     });
                 });

                 downloadCSV(csvContent, `HealthTrackPro_Detailed_${records[0].date}_to_${records[records.length-1].date}.csv`);
                 showToast('Detailed CSV report generated.', 'success');
             };

             /** Export daily summaries to CSV */
             const exportSummaryCSV = (records) => {
                if (records.length === 0) {
                     showToast('No data found for the selected period.', 'warning');
                     return;
                 }
                 let csvContent = "Date,Total Steps,Sleep Duration (hrs),Total Calories,Goals Met\n"; // Header

                 records.forEach(record => {
                     const goalsOnDate = getGoalsForDate(record.date);
                     const goalsMet = goalsMetForDay(record, goalsOnDate);
                     const sleepDisplay = record.sleepDuration === null ? '' : record.sleepDuration.toFixed(1);
                      const row = [
                          record.date,
                          record.totalSteps,
                          sleepDisplay,
                          record.totalCalories,
                          goalsMet ? 'Yes' : 'No'
                      ].join(',');
                      csvContent += row + "\n";
                 });

                 downloadCSV(csvContent, `HealthTrackPro_Summary_${records[0].date}_to_${records[records.length-1].date}.csv`);
                  showToast('Summary CSV report generated.', 'success');
             };

             /** Helper to trigger CSV download */
             const downloadCSV = (csvContent, filename) => {
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement("a");
                if (link.download !== undefined) { // Feature detection
                    const url = URL.createObjectURL(blob);
                    link.setAttribute("href", url);
                    link.setAttribute("download", filename);
                    link.style.visibility = 'hidden';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    URL.revokeObjectURL(url); // Clean up
                } else {
                    showToast("CSV download not supported by your browser.", "warning");
                }
            };

            /** Print history table */
             const printHistory = () => {
                 const tableHtml = document.getElementById('history-table').outerHTML;
                 const filter = document.getElementById('history-search').value;
                 const printWindow = window.open('', '_blank');
                 printWindow.document.write(`
                     <html>
                         <head>
                             <title>HealthTrack Pro History ${filter ? `(${filter})` : ''}</title>
                             <style>
                                 body { font-family: sans-serif; }
                                 table { width: 100%; border-collapse: collapse; font-size: 10pt; }
                                 th, td { border: 1px solid #ccc; padding: 4px 6px; text-align: left; }
                                 th { background-color: #f2f2f2; font-weight: bold; }
                                 .badge { display: inline-block; padding: 2px 5px; font-size: 8pt; border-radius: 3px; background-color: #eee; color: #333; }
                                 .badge-success { background-color: #d4edda; color: #155724; }
                                 .badge-outline-warning { border: 1px solid #ffeeba; color: #856404; background: transparent; }
                                 @media print {
                                     button { display: none; }
                                     h1 { font-size: 14pt; margin-bottom: 10px;}
                                 }
                             </style>
                         </head>
                         <body>
                             <h1>Health History ${filter ? `(Filtered: ${filter})` : ''}</h1>
                             ${tableHtml}
                              <button onclick="window.print()">Print</button>
                              <button onclick="window.close()">Close</button>
                         </body>
                     </html>
                 `);
                 printWindow.document.close(); // Necessary for some browsers
                 // printWindow.focus(); // Necessary for some browsers
                 // printWindow.print(); // Open print dialog automatically (optional)
             };

            /** Export all app data */
             const exportAllData = () => {
                 try {
                     const dataStr = JSON.stringify(appData, null, 2); // Pretty print JSON
                     const blob = new Blob([dataStr], { type: 'application/json' });
                     const filename = `HealthTrackPro_Backup_${formatDate()}.json`;
                     const link = document.createElement("a");
                     const url = URL.createObjectURL(blob);
                     link.setAttribute("href", url);
                     link.setAttribute("download", filename);
                     link.style.visibility = 'hidden';
                     document.body.appendChild(link);
                     link.click();
                     document.body.removeChild(link);
                     URL.revokeObjectURL(url);
                     showToast('All data exported successfully.', 'success');
                 } catch (error) {
                     console.error("Error exporting data:", error);
                     showToast('Failed to export data.', 'danger');
                 }
             };

             /** Trigger file input for import */
             const triggerImport = () => {
                 document.getElementById('import-file-input').click();
             };

             /** Handle imported file */
             const handleImportFile = (event) => {
                 const file = event.target.files[0];
                 if (!file) return;

                 const reader = new FileReader();
                 reader.onload = (e) => {
                     try {
                         const importedData = JSON.parse(e.target.result);
                         // Basic validation: Check for key properties
                         if (importedData.userSettings && importedData.goals && importedData.dailyRecords) {
                              showConfirmationModal(
                                 'Confirm Data Import',
                                 'This will overwrite your current application data with the contents of the selected file. Are you sure you want to proceed?',
                                 () => {
                                     appData = importedData; // Overwrite current data
                                     saveData(); // Save imported data
                                     showToast('Data imported successfully! Reloading application...', 'success');
                                     // Reload the page to apply all changes from imported data
                                     setTimeout(() => window.location.reload(), 1500);
                                 }
                             );
                         } else {
                             throw new Error("Invalid file format. Missing key properties.");
                         }
                     } catch (error) {
                         console.error("Error importing data:", error);
                         showToast(`Import failed: ${error.message}`, 'danger');
                     } finally {
                         // Reset file input value to allow importing the same file again if needed
                         event.target.value = null;
                     }
                 };
                 reader.onerror = () => {
                     showToast('Error reading the import file.', 'danger');
                      event.target.value = null;
                 };
                 reader.readAsText(file);
             };

             /** Reset all application data */
             const resetApplicationData = () => {
                showConfirmationModal(
                    'Confirm Data Reset',
                    'This will permanently delete all your tracked health data, goals, and settings. This action cannot be undone. Are you sure?',
                    () => {
                        localStorage.removeItem(APP_STORAGE_KEY); // Remove from storage
                        showToast('Application data reset. Reloading...', 'warning');
                         // Reload the page to start fresh with defaults
                        setTimeout(() => window.location.reload(), 1500);
                    }
                );
            };

            // ===== Charting Functions =====

            /** Initialize or update chart colors based on theme */
            const updateChartColors = () => {
                 // Update the global color object
                chartColors.primary = getCssVar('--primary-color');
                chartColors.success = getCssVar('--success-color');
                chartColors.warning = getCssVar('--warning-color');
                chartColors.danger = getCssVar('--danger-color');
                chartColors.text = getCssVar('--text-color');
                chartColors.textMuted = getCssVar('--text-muted');
                chartColors.grid = getCssVar('--border-color');

                // Update existing chart instances
                 const charts = [weeklyProgressChart, todayProgressChart, healthTrendsChart, goalCompletionChart];
                 charts.forEach(chart => {
                    if (chart) {
                         // Update grid/tick colors
                        if (chart.options.scales.x) chart.options.scales.x.grid.color = chartColors.grid;
                        if (chart.options.scales.y) chart.options.scales.y.grid.color = chartColors.grid;
                        if (chart.options.scales.x) chart.options.scales.x.ticks.color = chartColors.textMuted;
                        if (chart.options.scales.y) chart.options.scales.y.ticks.color = chartColors.textMuted;
                         // Update legend/tooltip colors if needed (might require more specific updates)
                        if (chart.options.plugins.legend) chart.options.plugins.legend.labels.color = chartColors.text;
                        // Redraw the chart
                        chart.update();
                    }
                });
             };


            /** Render Weekly/Monthly Progress Chart */
             const renderWeeklyProgressChart = (range = 'week') => {
                 const ctx = document.getElementById('weekly-progress-chart')?.getContext('2d');
                 if (!ctx) return;

                 const labels = [];
                 const stepsData = [];
                 const caloriesData = [];
                 const sleepData = []; // Optional

                 const today = new Date();
                 const daysToFetch = range === 'month' ? 30 : 7;

                 for (let i = daysToFetch - 1; i >= 0; i--) {
                     const date = new Date(today);
                     date.setDate(today.getDate() - i);
                     const dateStr = formatDate(date);
                     const record = getRecordByDate(dateStr);

                     labels.push(date); // Use Date objects for time scale
                     stepsData.push(record?.totalSteps ?? 0);
                     caloriesData.push(record?.totalCalories ?? 0);
                     sleepData.push(record?.sleepDuration ?? null); // Use null for missing sleep
                 }

                const datasets = [
                    {
                        label: 'Steps',
                        data: stepsData,
                        borderColor: chartColors.primary,
                        backgroundColor: hexToRgba(chartColors.primary, 0.1),
                        tension: 0.3,
                        yAxisID: 'ySteps',
                        fill: true,
                    },
                    {
                        label: 'Calories',
                        data: caloriesData,
                        borderColor: chartColors.warning,
                        backgroundColor: hexToRgba(chartColors.warning, 0.1),
                        tension: 0.3,
                        yAxisID: 'yCalories',
                        fill: true,
                        hidden: true // Start hidden maybe
                    },
                     {
                        label: 'Sleep (hrs)',
                        data: sleepData,
                        borderColor: chartColors.success,
                        backgroundColor: hexToRgba(chartColors.success, 0.1),
                        tension: 0.3,
                        yAxisID: 'ySleep',
                        fill: false, // Line only for sleep?
                        spanGaps: true, // Connect line over nulls
                        hidden: true
                    }
                ];

                 const chartConfig = {
                    type: 'line',
                    data: { labels, datasets },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: {
                            mode: 'index', // Show tooltips for all datasets at that point
                            intersect: false,
                        },
                        plugins: {
                            legend: {
                                position: 'top',
                                labels: { color: chartColors.text }
                            },
                            tooltip: {
                                 callbacks: { // Custom tooltip labels
                                     label: function(context) {
                                         let label = context.dataset.label || '';
                                         if (label) label += ': ';
                                         if (context.parsed.y !== null) {
                                              if(context.dataset.label === 'Sleep (hrs)') {
                                                  label += context.parsed.y.toFixed(1) + ' hrs';
                                              } else {
                                                  label += context.parsed.y.toLocaleString();
                                              }
                                         }
                                         return label;
                                     }
                                 }
                            }
                        },
                        scales: {
                            x: {
                                 type: 'time',
                                 time: {
                                     unit: range === 'month' ? 'day' : 'day', // Adjust unit based on range
                                     tooltipFormat: 'MMM d, yyyy', // Format for tooltip
                                     displayFormats: {
                                         day: 'MMM d' // Format for axis labels
                                     }
                                 },
                                grid: { color: chartColors.grid, drawOnChartArea: false },
                                ticks: { color: chartColors.textMuted, maxRotation: 0, autoSkip: true, maxTicksLimit: range === 'month' ? 15 : 7 },
                            },
                            ySteps: {
                                type: 'linear',
                                position: 'left',
                                beginAtZero: true,
                                grid: { color: chartColors.grid },
                                ticks: { color: chartColors.textMuted },
                                title: { display: true, text: 'Steps', color: chartColors.primary }
                            },
                            yCalories: {
                                type: 'linear',
                                position: 'right',
                                beginAtZero: true,
                                grid: { drawOnChartArea: false }, // Only draw grid for primary axis
                                ticks: { color: chartColors.textMuted },
                                title: { display: true, text: 'Calories (kcal)', color: chartColors.warning }
                            },
                             ySleep: {
                                type: 'linear',
                                position: 'right', // Can overlay on calories axis
                                beginAtZero: true,
                                grid: { drawOnChartArea: false },
                                ticks: { color: chartColors.textMuted },
                                title: { display: true, text: 'Sleep (hrs)', color: chartColors.success },
                                display: false // Initially hide sleep axis unless shown
                            }
                        }
                    }
                };

                 if (weeklyProgressChart) {
                    weeklyProgressChart.data = chartConfig.data;
                     // Adjust x-axis time unit based on range
                    weeklyProgressChart.options.scales.x.time.unit = range === 'month' ? 'day' : 'day';
                     weeklyProgressChart.options.scales.x.ticks.maxTicksLimit = range === 'month' ? 15 : 7;
                     // Update which axes are visible based on dataset visibility
                     weeklyProgressChart.options.scales.yCalories.display = !weeklyProgressChart.getDataVisibility(1);
                     weeklyProgressChart.options.scales.ySleep.display = !weeklyProgressChart.getDataVisibility(2);
                    weeklyProgressChart.update();
                 } else {
                     weeklyProgressChart = new Chart(ctx, chartConfig);
                 }
             };

            /** Render Today's Goal Progress Chart (e.g., Radar or Doughnut) */
             const renderTodayProgressChart = () => {
                 const ctx = document.getElementById('today-progress-chart')?.getContext('2d');
                 if (!ctx) return;

                 const todayRecord = getRecordByDate(formatDate()) || {};
                 const goals = appData.goals;

                 // Calculate percentage completion for each goal
                 const stepsPercent = goals.steps > 0 ? Math.min(100, (todayRecord.totalSteps / goals.steps) * 100) : 0;
                 const sleepPercent = goals.sleep > 0 && todayRecord.sleepDuration !== null ? Math.min(100, (todayRecord.sleepDuration / goals.sleep) * 100) : 0;
                 // Calorie percentage: 100% if 0 or below goal, decreases to 0% if double the goal
                 let caloriesPercent = 0;
                 if (goals.calories > 0 && todayRecord.totalCalories !== null) {
                     if (todayRecord.totalCalories <= goals.calories) {
                         caloriesPercent = 100;
                     } else {
                          // Decreases from 100 to 0 as calories go from goal to 2*goal
                         caloriesPercent = Math.max(0, 100 - ((todayRecord.totalCalories - goals.calories) / goals.calories) * 100);
                     }
                 } else if (goals.calories > 0 && todayRecord.totalCalories === null) {
                    caloriesPercent = 0; // If goal exists but no data, count as 0%
                 }


                  const chartData = {
                     labels: ['Steps', 'Sleep', 'Calories'],
                     datasets: [{
                         label: 'Goal Completion',
                         data: [stepsPercent, sleepPercent, caloriesPercent],
                         backgroundColor: [
                             hexToRgba(chartColors.primary, 0.6),
                             hexToRgba(chartColors.success, 0.6),
                             hexToRgba(chartColors.warning, 0.6),
                         ],
                         borderColor: [
                             chartColors.primary,
                             chartColors.success,
                             chartColors.warning,
                         ],
                         borderWidth: 1
                     }]
                 };

                 const chartConfig = {
                    type: 'doughnut', // Or 'radar'
                    data: chartData,
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                         plugins: {
                            legend: {
                                position: 'bottom',
                                labels: { color: chartColors.text }
                            },
                            tooltip: {
                                callbacks: {
                                     label: function(context) {
                                         return `${context.label}: ${context.parsed.toFixed(0)}%`;
                                     }
                                 }
                            }
                        },
                        // Radar specific options if using type: 'radar'
                        /* scales: {
                             r: {
                                 angleLines: { color: chartColors.grid },
                                 grid: { color: chartColors.grid },
                                 pointLabels: { color: chartColors.text },
                                 ticks: {
                                     backdropColor: getCssVar('--card-background'), // Background for ticks
                                     color: chartColors.textMuted,
                                     stepSize: 25, // Steps of 25%
                                     callback: function(value) { return value + '%'; }
                                 },
                                 suggestedMin: 0,
                                 suggestedMax: 100
                             }
                         } */
                    }
                };

                 if (todayProgressChart) {
                    todayProgressChart.data = chartData;
                    todayProgressChart.update();
                 } else {
                    todayProgressChart = new Chart(ctx, chartConfig);
                 }
            };

            /** Render Health Trends Chart */
            const renderHealthTrendsChart = (range = 'week') => {
                 const ctx = document.getElementById('health-trends-chart')?.getContext('2d');
                 if (!ctx) return;

                 const labels = [];
                 const stepsData = [];
                 const sleepData = [];
                 const caloriesData = [];

                 const today = new Date();
                 let daysToFetch;
                 let timeUnit;

                 switch(range) {
                    case 'month': daysToFetch = 30; timeUnit = 'day'; break;
                    case 'year': daysToFetch = 365; timeUnit = 'month'; break;
                    case 'week':
                    default: daysToFetch = 7; timeUnit = 'day'; break;
                 }

                 // Aggregate data for longer ranges (year)
                 if (range === 'year') {
                     const monthlyData = {}; // { 'YYYY-MM': { steps: [], sleep: [], calories: [] } }
                     for (let i = daysToFetch - 1; i >= 0; i--) {
                         const date = new Date(today);
                         date.setDate(today.getDate() - i);
                         const dateStr = formatDate(date);
                         const record = getRecordByDate(dateStr);
                         if (record) {
                             const monthStr = dateStr.substring(0, 7); // YYYY-MM
                             if (!monthlyData[monthStr]) {
                                 monthlyData[monthStr] = { steps: [], sleep: [], calories: [] };
                             }
                             monthlyData[monthStr].steps.push(record.totalSteps);
                             if(record.sleepDuration !== null) monthlyData[monthStr].sleep.push(record.sleepDuration);
                             if(record.totalCalories > 0) monthlyData[monthStr].calories.push(record.totalCalories);
                         }
                     }
                     // Calculate monthly averages
                     const sortedMonths = Object.keys(monthlyData).sort();
                     sortedMonths.forEach(monthStr => {
                          labels.push(new Date(monthStr + '-01T00:00:00')); // Use first day of month for label
                          const month = monthlyData[monthStr];
                          stepsData.push(month.steps.length ? month.steps.reduce((a, b) => a + b, 0) / month.steps.length : 0);
                          sleepData.push(month.sleep.length ? month.sleep.reduce((a, b) => a + b, 0) / month.sleep.length : null);
                          caloriesData.push(month.calories.length ? month.calories.reduce((a, b) => a + b, 0) / month.calories.length : 0);
                     });

                 } else { // Week or Month view (daily data)
                    for (let i = daysToFetch - 1; i >= 0; i--) {
                         const date = new Date(today);
                         date.setDate(today.getDate() - i);
                         const dateStr = formatDate(date);
                         const record = getRecordByDate(dateStr);

                         labels.push(date);
                         stepsData.push(record?.totalSteps ?? 0);
                         sleepData.push(record?.sleepDuration ?? null);
                         caloriesData.push(record?.totalCalories ?? 0);
                     }
                 }


                  const datasets = [
                    {
                        label: 'Avg Steps', // Label changes for year view
                        data: stepsData,
                        borderColor: chartColors.primary,
                        tension: 0.1, // Less curve for trends
                        yAxisID: 'ySteps',
                        pointRadius: range === 'year' ? 3 : 1, // Larger points for monthly avg
                        pointHoverRadius: range === 'year' ? 5 : 3,
                    },
                    {
                        label: 'Avg Sleep (hrs)',
                        data: sleepData,
                        borderColor: chartColors.success,
                        tension: 0.1,
                        yAxisID: 'ySleep',
                        spanGaps: true,
                        pointRadius: range === 'year' ? 3 : 1,
                        pointHoverRadius: range === 'year' ? 5 : 3,
                    },
                    {
                        label: 'Avg Calories',
                        data: caloriesData,
                        borderColor: chartColors.warning,
                        tension: 0.1,
                        yAxisID: 'yCalories',
                        pointRadius: range === 'year' ? 3 : 1,
                        pointHoverRadius: range === 'year' ? 5 : 3,
                         hidden: true // Hide calories by default maybe
                    }
                 ];
                 // Adjust labels for year view
                 if (range === 'year') {
                    datasets[0].label = 'Avg Daily Steps';
                    datasets[1].label = 'Avg Daily Sleep (hrs)';
                    datasets[2].label = 'Avg Daily Calories';
                 }


                 const chartConfig = {
                    type: 'line',
                    data: { labels, datasets },
                     options: { // Similar options to weekly progress, adjust axis/tooltip formats
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: { mode: 'index', intersect: false },
                        plugins: {
                            legend: { position: 'top', labels: { color: chartColors.text } },
                             tooltip: {
                                 callbacks: { // Custom tooltip labels
                                     label: function(context) {
                                         let label = context.dataset.label || '';
                                         if (label) label += ': ';
                                         if (context.parsed.y !== null) {
                                              if(context.dataset.label.includes('Sleep')) {
                                                  label += context.parsed.y.toFixed(1) + ' hrs';
                                              } else {
                                                  label += context.parsed.y.toFixed(0); // Use toFixed(0) for averages
                                              }
                                         }
                                         return label;
                                     }
                                 }
                             }
                        },
                        scales: {
                             x: {
                                 type: 'time',
                                 time: {
                                     unit: timeUnit,
                                     tooltipFormat: range === 'year' ? 'MMM yyyy' : 'MMM d, yyyy',
                                     displayFormats: {
                                         day: 'MMM d',
                                         month: 'MMM yyyy'
                                     }
                                 },
                                grid: { color: chartColors.grid, drawOnChartArea: false },
                                ticks: { color: chartColors.textMuted, autoSkip: true, maxRotation: 0, maxTicksLimit: range === 'year' ? 12 : (range === 'month' ? 15 : 7) },
                            },
                            ySteps: {
                                type: 'linear', position: 'left', beginAtZero: true,
                                grid: { color: chartColors.grid }, ticks: { color: chartColors.textMuted },
                                title: { display: true, text: 'Steps', color: chartColors.primary }
                            },
                             ySleep: {
                                type: 'linear', position: 'right', beginAtZero: true,
                                grid: { drawOnChartArea: false }, ticks: { color: chartColors.textMuted },
                                title: { display: true, text: 'Sleep (hrs)', color: chartColors.success }
                            },
                            yCalories: {
                                type: 'linear', position: 'right', beginAtZero: true, // Overlay with sleep
                                grid: { drawOnChartArea: false }, ticks: { color: chartColors.textMuted },
                                title: { display: true, text: 'Calories', color: chartColors.warning },
                                display: false // Hide unless dataset is visible
                            }
                        }
                     }
                 };


                 if (healthTrendsChart) {
                     healthTrendsChart.data = chartConfig.data;
                     healthTrendsChart.options.scales.x.time.unit = timeUnit;
                     healthTrendsChart.options.scales.x.time.tooltipFormat = range === 'year' ? 'MMM yyyy' : 'MMM d, yyyy';
                     healthTrendsChart.options.scales.x.ticks.maxTicksLimit = range === 'year' ? 12 : (range === 'month' ? 15 : 7);
                      // Update axis visibility
                     healthTrendsChart.options.scales.yCalories.display = !healthTrendsChart.getDataVisibility(2);
                     healthTrendsChart.update();
                 } else {
                    healthTrendsChart = new Chart(ctx, chartConfig);
                 }
            };

            /** Render Goal Completion Rate Chart (e.g., Bar chart over time) */
            const renderGoalCompletionRateChart = (period = 'week') => {
                const ctx = document.getElementById('goal-completion-chart')?.getContext('2d');
                if (!ctx) return;

                const labels = [];
                const completionRates = []; // Overall completion %

                 const today = new Date();
                 let daysToFetch;
                 let timeUnit;

                 switch(period) {
                     case 'month': daysToFetch = 30; timeUnit = 'day'; break;
                     case 'year': daysToFetch = 365; timeUnit = 'month'; break; // Aggregate monthly
                     case 'week':
                     default: daysToFetch = 7; timeUnit = 'day'; break;
                 }

                 if (period === 'year') {
                     const monthlyCompletion = {}; // { 'YYYY-MM': { rates: [], count: 0 } }
                     for (let i = daysToFetch - 1; i >= 0; i--) {
                         const date = new Date(today);
                         date.setDate(today.getDate() - i);
                         const dateStr = formatDate(date);
                         const record = getRecordByDate(dateStr);
                         if (record) {
                              const goalsOnDate = getGoalsForDate(dateStr);
                              const completion = calculateGoalCompletionPercentage(record, goalsOnDate);
                              const monthStr = dateStr.substring(0, 7);
                              if (!monthlyCompletion[monthStr]) {
                                 monthlyCompletion[monthStr] = { rates: [], count: 0 };
                              }
                              monthlyCompletion[monthStr].rates.push(completion);
                              monthlyCompletion[monthStr].count++;
                         }
                     }
                      const sortedMonths = Object.keys(monthlyCompletion).sort();
                      sortedMonths.forEach(monthStr => {
                          labels.push(new Date(monthStr + '-01T00:00:00'));
                          const month = monthlyCompletion[monthStr];
                          const avgRate = month.rates.length ? month.rates.reduce((a, b) => a + b, 0) / month.rates.length : 0;
                          completionRates.push(avgRate);
                      });
                 } else { // Week or Month view
                     for (let i = daysToFetch - 1; i >= 0; i--) {
                         const date = new Date(today);
                         date.setDate(today.getDate() - i);
                         const dateStr = formatDate(date);
                         const record = getRecordByDate(dateStr);
                         const goalsOnDate = getGoalsForDate(dateStr); // Use goals active on that day
                         const completion = record ? calculateGoalCompletionPercentage(record, goalsOnDate) : 0;

                         labels.push(date);
                         completionRates.push(completion);
                     }
                 }


                 const chartConfig = {
                     type: 'bar',
                     data: {
                         labels: labels,
                         datasets: [{
                             label: 'Goal Completion Rate (%)',
                             data: completionRates,
                             backgroundColor: completionRates.map(rate => rate >= 80 ? chartColors.success : (rate >= 50 ? chartColors.primary : chartColors.warning)), // Color bars based on rate
                             borderColor: completionRates.map(rate => rate >= 80 ? chartColors.success : (rate >= 50 ? chartColors.primary : chartColors.warning)),
                             borderWidth: 1
                         }]
                     },
                     options: {
                         responsive: true,
                         maintainAspectRatio: false,
                         plugins: {
                            legend: { display: false }, // Hide legend for single dataset
                            tooltip: {
                                callbacks: {
                                     label: function(context) {
                                         return `Completion: ${context.parsed.y.toFixed(0)}%`;
                                     }
                                 }
                            }
                         },
                         scales: {
                             x: {
                                 type: 'time',
                                 time: {
                                     unit: timeUnit,
                                     tooltipFormat: period === 'year' ? 'MMM yyyy' : 'MMM d, yyyy',
                                      displayFormats: {
                                         day: 'MMM d',
                                         month: 'MMM yy' // Shorter year format
                                     }
                                 },
                                 grid: { display: false },
                                 ticks: { color: chartColors.textMuted, autoSkip: true, maxRotation: 0, maxTicksLimit: period === 'year' ? 12 : (period === 'month' ? 15 : 7) }
                             },
                             y: {
                                 beginAtZero: true,
                                 max: 100, // Max percentage is 100
                                 grid: { color: chartColors.grid },
                                 ticks: {
                                     color: chartColors.textMuted,
                                     stepSize: 20,
                                     callback: function(value) { return value + '%'; }
                                 },
                                 title: { display: true, text: 'Completion Rate', color: chartColors.text }
                             }
                         }
                     }
                 };


                if (goalCompletionChart) {
                    goalCompletionChart.data = chartConfig.data;
                    goalCompletionChart.options.scales.x.time.unit = timeUnit;
                    goalCompletionChart.options.scales.x.time.tooltipFormat = period === 'year' ? 'MMM yyyy' : 'MMM d, yyyy';
                    goalCompletionChart.options.scales.x.ticks.maxTicksLimit = period === 'year' ? 12 : (period === 'month' ? 15 : 7);
                    goalCompletionChart.update();
                 } else {
                    goalCompletionChart = new Chart(ctx, chartConfig);
                 }
            };

             /** Helper function to convert hex color to rgba */
             const hexToRgba = (hex, alpha = 1) => {
                // Check if it's an HSL string first
                 if (hex.startsWith('hsl')) {
                    // Attempt to convert HSL to RGBA - this is complex,
                    // might be better to define RGBA variables in CSS or use a library.
                    // Basic placeholder: return semi-transparent primary for HSL inputs
                     console.warn("Direct HSL to RGBA conversion not implemented, using fallback.");
                     const prim = getCssVar('--primary-color'); // Get primary as fallback
                     if (prim.startsWith('#')) { // If primary is hex
                         // Proceed with hex conversion for primary
                         hex = prim;
                     } else {
                         return `rgba(70, 130, 180, ${alpha})`; // Default blueish rgba
                     }
                 }

                 let r = 0, g = 0, b = 0;
                 if (hex.length == 4) { // Expand shorthand hex
                     r = parseInt(hex[1] + hex[1], 16);
                     g = parseInt(hex[2] + hex[2], 16);
                     b = parseInt(hex[3] + hex[3], 16);
                 } else if (hex.length == 7) {
                     r = parseInt(hex[1] + hex[2], 16);
                     g = parseInt(hex[3] + hex[4], 16);
                     b = parseInt(hex[5] + hex[6], 16);
                 } else {
                     // Handle invalid hex format - return transparent or default
                      console.warn("Invalid hex color format:", hex);
                      return `rgba(0, 0, 0, 0)`; // Transparent black
                 }
                 return `rgba(${r}, ${g}, ${b}, ${alpha})`;
             };

            // ===== Tour Guide Logic =====
            const tourSteps = [
                 { element: '.logo', title: 'Brand Logo', content: 'This is the application logo and name. Click it to return to the Overview.' },
                 { element: '.nav-list a[data-section="overview"]', title: 'Navigation', content: 'Use the sidebar to navigate between different sections like Overview, Tracking, History, etc.' },
                 { element: '.stats-grid .stat-card:first-child', title: 'Stat Cards', content: 'These cards show your key metrics for today compared to your goals.' },
                 { element: '#weekly-progress-chart', title: 'Progress Chart', content: 'Visualize your progress over the selected time range (Week/Month).' },
                 { element: '#tracking', title: 'Tracking Section', content: 'Navigate here to manually add your steps, sleep, or calorie intake for the day.', navigateTo: 'tracking' }, // Will navigate before showing
                 { element: '#tracking-form', title: 'Add Data', content: 'Enter your data in these fields and click "Add Entries" to save.' },
                 { element: '#goals', title: 'Goals Section', content: 'Set your personal daily health goals here.', navigateTo: 'goals' },
                 { element: '#save-goals', title: 'Update Goals', content: 'After adjusting your targets, click here to save them.' },
                 { element: '#theme-toggle', title: 'Theme Toggle', content: 'Switch between light and dark modes.' },
                 { element: '#tour-start', title: 'Tour Complete!', content: 'You can restart this tour anytime by clicking this button again. Enjoy using HealthTrack Pro!' }
             ];
             let currentTourStep = 0;
             let tourInProgress = false;

             const tourOverlay = document.getElementById('tour-overlay');
             const tourHighlight = document.getElementById('tour-highlight');
             const tourTooltip = document.getElementById('tour-tooltip');
             const tourTooltipTitle = document.getElementById('tour-tooltip-title');
             const tourTooltipContent = document.getElementById('tour-tooltip-content');
             const tourStepIndicator = document.getElementById('tour-step-indicator');
             const tourNextBtn = document.getElementById('tour-next');
             const tourPrevBtn = document.getElementById('tour-prev');
             const tourSkipBtn = document.getElementById('tour-skip');

             const positionTourElements = (targetElement) => {
                if (!targetElement) {
                     endTour();
                     return;
                }
                 const targetRect = targetElement.getBoundingClientRect();
                 const tooltipRect = tourTooltip.getBoundingClientRect();
                 const highlightMargin = 5; // Space around target

                 // Position Highlight
                 tourHighlight.style.top = `${targetRect.top - highlightMargin}px`;
                 tourHighlight.style.left = `${targetRect.left - highlightMargin}px`;
                 tourHighlight.style.width = `${targetRect.width + highlightMargin * 2}px`;
                 tourHighlight.style.height = `${targetRect.height + highlightMargin * 2}px`;

                 // Position Tooltip (try below first, then above)
                 let tooltipTop = targetRect.bottom + 10; // 10px margin below
                 let tooltipLeft = targetRect.left + targetRect.width / 2 - tooltipRect.width / 2;

                 // Adjust if tooltip goes off screen bottom
                 if (tooltipTop + tooltipRect.height > window.innerHeight) {
                     tooltipTop = targetRect.top - tooltipRect.height - 10; // Position above
                 }
                 // Adjust if tooltip goes off screen top
                  if (tooltipTop < 0) {
                     tooltipTop = 10; // Fallback position near top
                  }

                 // Adjust horizontal position to keep within viewport
                 tooltipLeft = Math.max(10, Math.min(tooltipLeft, window.innerWidth - tooltipRect.width - 10));

                 tourTooltip.style.top = `${tooltipTop}px`;
                 tourTooltip.style.left = `${tooltipLeft}px`;
             };

             const showTourStep = (stepIndex) => {
                if (stepIndex < 0 || stepIndex >= tourSteps.length) {
                     endTour();
                     return;
                }
                 currentTourStep = stepIndex;
                 const step = tourSteps[stepIndex];

                 // Handle navigation first if needed
                 if (step.navigateTo) {
                    showSection(step.navigateTo);
                     // Need a slight delay for section transition and element availability
                     setTimeout(() => proceedWithStep(step), 300);
                 } else {
                     proceedWithStep(step);
                 }
             };

             const proceedWithStep = (step) => {
                 const targetElement = document.querySelector(step.element);

                 if (!targetElement || targetElement.offsetParent === null) { // Check if element exists and is visible
                     console.warn(`Tour target not found or not visible: ${step.element}`);
                     // Option 1: Skip step
                      // showTourStep(currentTourStep + 1);
                     // Option 2: End tour
                     showToast('Tour element not found. Ending tour.', 'warning');
                     endTour();
                     return;
                 }

                 // Ensure target is scrolled into view
                 targetElement.scrollIntoView({ behavior: 'smooth', block: 'center', inline: 'nearest' });

                 // Update tooltip content after scrolling potentially finishes
                 setTimeout(() => {
                     tourTooltipTitle.textContent = step.title;
                     tourTooltipContent.innerHTML = `<p>${step.content}</p>`; // Use innerHTML to allow basic formatting if needed
                     tourStepIndicator.textContent = `Step ${currentTourStep + 1} / ${tourSteps.length}`;

                     // Update button states
                     tourPrevBtn.disabled = currentTourStep === 0;
                     tourNextBtn.textContent = currentTourStep === tourSteps.length - 1 ? 'Finish' : 'Next';

                     // Position elements relative to the target
                     positionTourElements(targetElement);

                     // Show tooltip
                     tourTooltip.classList.remove('hidden');
                     tourTooltip.classList.add('show'); // Trigger animation
                 }, 300); // Delay after scrollIntoView

             };


             const startTour = () => {
                if (tourInProgress) return;
                tourInProgress = true;
                console.log("Starting tour...");
                 tourOverlay.classList.add('show');
                 showTourStep(0);
                 // Recalculate position on resize/scroll while tour is active
                 window.addEventListener('resize', debouncedPositionTour);
                 window.addEventListener('scroll', debouncedPositionTour, true); // Use capture phase for scroll
            };

            const endTour = () => {
                 console.log("Ending tour.");
                 tourInProgress = false;
                 tourOverlay.classList.remove('show');
                 tourHighlight.style.width = '0'; // Collapse highlight
                 tourHighlight.style.height = '0';
                 tourTooltip.classList.remove('show');
                 tourTooltip.classList.add('hidden');
                 window.removeEventListener('resize', debouncedPositionTour);
                 window.removeEventListener('scroll', debouncedPositionTour, true);
                 currentTourStep = 0; // Reset step
            };

             // Debounced version of positioning for performance
             const debouncedPositionTour = debounce(() => {
                 if (tourInProgress) {
                      const step = tourSteps[currentTourStep];
                      const targetElement = document.querySelector(step.element);
                      positionTourElements(targetElement);
                 }
             }, 100); // Adjust delay as needed


            // ===== Event Listeners =====

            /** Theme Toggle Listener */
            themeToggle.addEventListener('click', () => {
                const current = getCurrentTheme();
                 let newThemePref;
                 // Cycle through light -> dark -> system -> light ...
                 if (appData.userSettings.theme === 'light') newThemePref = 'dark';
                 else if (appData.userSettings.theme === 'dark') newThemePref = 'system';
                 else newThemePref = 'light'; // If system, go to light

                 appData.userSettings.theme = newThemePref;
                applyTheme();
                saveData();
            });

             /** Sidebar Toggle Listener */
             sidebarToggle.addEventListener('click', toggleSidebar);
             menuToggle.addEventListener('click', toggleSidebar); // Mobile burger uses same function

             /** Close mobile sidebar when clicking overlay */
             document.body.addEventListener('click', (event) => {
                 if (window.innerWidth <= 1024 && document.body.classList.contains('sidebar-open')) {
                      // Check if click is outside the sidebar itself
                      if (!sidebar.contains(event.target) && event.target !== menuToggle && !menuToggle.contains(event.target)) {
                          toggleSidebar();
                      }
                 }
             });


            /** Navigation Link Listeners */
            navLinks.forEach(link => {
                link.addEventListener('click', (event) => {
                    event.preventDefault();
                    const sectionId = link.dataset.section;
                     if (sectionId) {
                        showSection(sectionId);
                         // Close mobile sidebar after navigation
                         if (window.innerWidth <= 1024 && document.body.classList.contains('sidebar-open')) {
                            toggleSidebar();
                         }
                         // Update URL hash if using href attribute
                         // window.location.hash = link.getAttribute('href');
                     }
                });
            });
             /** Navigation via buttons (e.g., View All Badges) */
            document.addEventListener('click', (event) => {
                const navButton = event.target.closest('.nav-link-btn');
                 if (navButton && navButton.dataset.section) {
                    showSection(navButton.dataset.section);
                 }
            });


             /** Tracking Form Submit Listener */
            trackingForm.addEventListener('submit', handleTrackingFormSubmit);

             /** Clear Today Button Listener */
            document.getElementById('clear-today').addEventListener('click', () => {
                showConfirmationModal(
                    'Confirm Clear Entries',
                    "Are you sure you want to delete all of today's logged entries? This cannot be undone.",
                    () => {
                        const todayRecord = getTodayRecord();
                        todayRecord.entries = [];
                        todayRecord.totalSteps = 0;
                        todayRecord.sleepDuration = null;
                        todayRecord.totalCalories = 0;
                        todayRecord.goalsMet = false;

                        updateTodayEntriesTable();
                        updateOverviewStats();
                        renderTodayProgressChart();
                         // Don't reset streak immediately, updateStreaks will handle it
                        updateStreaksAndGoalsMet();
                        // Don't remove achievements
                        displayHealthTip();
                         renderStreakCalendar();

                        saveData();
                        showToast("Today's entries cleared.", 'info');
                    }
                );
            });

             /** Edit/Delete Entry Button Listeners (Event Delegation) */
            document.getElementById('today-entries-tbody').addEventListener('click', (event) => {
                 const editButton = event.target.closest('.edit-entry-btn');
                 const deleteButton = event.target.closest('.delete-entry-btn');
                 const entryRow = event.target.closest('tr');

                 if (!entryRow || !entryRow.dataset.entryId) return;

                 const entryId = entryRow.dataset.entryId;
                 const entryDate = formatDate(); // Entries are always for today
                 const record = getRecordByDate(entryDate);
                 const entry = record?.entries.find(e => e.id == entryId);

                 if (!entry) return;

                 if (editButton) {
                     // --- Populate and Show Edit Modal ---
                     showModal('entry-detail-modal', () => {
                         document.getElementById('edit-entry-id').value = entry.id;
                         document.getElementById('edit-entry-date').value = entryDate;
                         document.getElementById('edit-entry-value').value = entry.value;
                         document.getElementById('edit-entry-value').min = 0; // Standard min
                         document.getElementById('edit-entry-value').step = (entry.type === 'sleep' ? 0.1 : 1); // Step for sleep
                         document.getElementById('edit-entry-value').max = (entry.type === 'sleep' ? 24 : ''); // Max for sleep
                         document.getElementById('edit-entry-label').textContent = `Edit ${entry.type} value:`;
                         document.getElementById('edit-entry-time').textContent = `Original entry time: ${entry.time}`;
                          // Clear previous validation
                         document.getElementById('edit-entry-value').parentElement.classList.remove('error');
                         entryDetailModal.querySelector('.form-error').style.display = 'none';
                     });
                 } else if (deleteButton) {
                     // --- Show Confirmation for Delete ---
                     showConfirmationModal(
                        'Confirm Delete Entry',
                        `Are you sure you want to delete this ${entry.type} entry (${entry.value})?`,
                        () => {
                            deleteEntry(entryId, entryDate);
                        }
                    );
                 }
            });

             /** Edit Entry Modal Save/Delete Listener */
             document.getElementById('edit-entry-form').addEventListener('submit', handleEditEntryFormSubmit);
             document.getElementById('delete-entry').addEventListener('click', () => {
                 // Trigger confirmation from within the edit modal context
                 const entryId = document.getElementById('edit-entry-id').value;
                 const entryDate = document.getElementById('edit-entry-date').value;
                 const record = getRecordByDate(entryDate);
                 const entry = record?.entries.find(e => e.id == entryId);
                 if (!entry) return;

                  showConfirmationModal(
                        'Confirm Delete Entry',
                        `Are you sure you want to delete this ${entry.type} entry (${entry.value})?`,
                        () => {
                            deleteEntry(entryId, entryDate); // Call delete directly
                        }
                    );
             });

             /** Goals Form Submit Listener */
             goalsForm.addEventListener('submit', handleGoalsFormSubmit);

             /** History Search Listener */
             document.getElementById('history-search').addEventListener('input', debounce((event) => {
                 renderHistoryTable(event.target.value.trim());
             }, 300)); // Debounce search input

            /** History Export/Print Listeners */
            document.getElementById('export-csv').addEventListener('click', () => {
                 const filter = document.getElementById('history-search').value.trim();
                 const records = Object.values(appData.dailyRecords)
                     .filter(record => record.date.includes(filter))
                     .sort((a, b) => a.date.localeCompare(b.date)); // Oldest first
                 exportSummaryCSV(records);
            });
            document.getElementById('print-history').addEventListener('click', printHistory);

             /** Report Generation Form Listener */
             reportGenerationForm.addEventListener('submit', handleReportGeneration);

             /** Chart Toggle Button Listeners (using event delegation) */
             document.getElementById('weekly-progress-toggle')?.addEventListener('click', (event) => {
                 if (event.target.matches('.time-range')) {
                      document.querySelectorAll('#weekly-progress-toggle .time-range').forEach(btn => btn.classList.remove('active'));
                      event.target.classList.add('active');
                      renderWeeklyProgressChart(event.target.dataset.range);
                 }
             });
             document.getElementById('trends-chart-toggle')?.addEventListener('click', (event) => {
                 if (event.target.matches('.trend-range')) {
                      document.querySelectorAll('#trends-chart-toggle .trend-range').forEach(btn => btn.classList.remove('active'));
                      event.target.classList.add('active');
                      renderHealthTrendsChart(event.target.dataset.range);
                 }
             });
             document.getElementById('goal-completion-period')?.addEventListener('change', (event) => {
                 renderGoalCompletionRateChart(event.target.value);
             });

             /** Refresh Insights Button */
            document.getElementById('refresh-insights')?.addEventListener('click', generateAndDisplayInsights);

            /** Settings Page Listeners */
             document.querySelectorAll('.theme-setting').forEach(button => {
                 button.addEventListener('click', (event) => {
                    appData.userSettings.theme = event.currentTarget.dataset.themeValue;
                    applyTheme();
                    saveData();
                 });
             });
             document.getElementById('export-all-data')?.addEventListener('click', exportAllData);
             document.getElementById('import-data')?.addEventListener('click', triggerImport);
             document.getElementById('import-file-input')?.addEventListener('change', handleImportFile);
             document.getElementById('reset-app-data')?.addEventListener('click', resetApplicationData);

            /** Tour Guide Listeners */
            document.getElementById('tour-start').addEventListener('click', startTour);
            tourNextBtn.addEventListener('click', () => showTourStep(currentTourStep + 1));
            tourPrevBtn.addEventListener('click', () => showTourStep(currentTourStep - 1));
            tourSkipBtn.addEventListener('click', endTour);
             // Close tour if overlay is clicked
             tourOverlay.addEventListener('click', (event) => {
                 if (event.target === tourOverlay) { // Only if overlay itself is clicked
                      endTour();
                 }
             });
              // Close tour on Escape key
             document.addEventListener('keydown', (event) => {
                 if (tourInProgress && event.key === 'Escape') {
                     endTour();
                 }
             });

            /** Window Resize Listener (for responsive UI adjustments) */
            window.addEventListener('resize', debounce(() => {
                 applySidebarState(); // Adjust sidebar for desktop/mobile
                 // Charts might need updates if container size changed significantly
                 // updateChartColors(); // Already handled by theme toggle, maybe needed here too?
            }, 200));

            // ===== Initialization =====
            const initializeApp = () => {
                console.log("Initializing HealthTrack Pro...");
                loadData(); // Load data first
                applyTheme(); // Apply theme based on loaded settings
                applySidebarState(); // Apply sidebar state
                updateTodayDateDisplay();
                currentYearSpan.textContent = new Date().getFullYear();

                // Recalculate streaks on load to ensure consistency
                 recalculateStreaks(); // This also saves data

                 // Initial UI population based on loaded data
                 populateGoalsForm(); // Populate goals form first

                // Show last visited section or default to overview
                const initialSection = appData.userSettings.lastVisitedSection || 'overview';
                 // Validate section exists, fallback if not
                 const validInitialSection = document.getElementById(initialSection) ? initialSection : 'overview';
                showSection(validInitialSection);


                // Final check for achievements earned offline/historically
                // checkAndGrantAchievements(); // Potentially call this to check all achievements against loaded history
                // saveData(); // Save any achievements granted on load

                console.log("Initialization complete.");
            };

            // Run initialization when the DOM is ready
            document.addEventListener('DOMContentLoaded', initializeApp);

        })(); // End IIFE - This parenthesis closes the function execution call
    </script>

</body>
</html>
